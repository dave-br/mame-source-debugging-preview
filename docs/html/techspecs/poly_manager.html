<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Software 3D Rendering in MAME &mdash; MAME Documentation 0.280 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=e8156010"></script>
        <script src="../_static/doctools.js?v=9bcbadda"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Audio effects" href="audio_effects.html" />
    <link rel="prev" title="UML Instruction Reference" href="uml_instructions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MAME Documentation
          </a>
              <div class="version">
                0.280
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whatis.html">What is MAME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../healthwarning.html">Health Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../initialsetup/index.html">Getting MAME prepared</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usingmame/index.html">Basic MAME Usage and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commandline/index.html">MAME Command-line Usage and OS-Specific Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">Advanced configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugger/index.html">MAME Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../luascript/index.html">Lua Scripting Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">MAME External Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing to MAME</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Technical Specifications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="naming.html">MAME Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_files.html">MAME Layout Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_script.html">MAME Layout Scripting</a></li>
<li class="toctree-l2"><a class="reference internal" href="object_finders.html">Object Finders</a></li>
<li class="toctree-l2"><a class="reference internal" href="inputsystem.html">Input System</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_memory_interface.html">The device_memory_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_rom_interface.html">The device_rom_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_disasm_interface.html">The device_disasm_interface and the disassemblers</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_sound_interface.html">The device_sound_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Emulated system memory and address spaces management</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpu_device.html">CPU devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="floppy.html">The new floppy subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="nscsi.html">The new SCSI subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="m6502.html">The new 6502 family implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="uml_instructions.html">UML Instruction Reference</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Software 3D Rendering in MAME</a></li>
<li class="toctree-l2"><a class="reference internal" href="audio_effects.html">Audio effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="osd_audio.html">OSD audio support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">MAME and security concerns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">The MAME License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MAME Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Technical Specifications</a></li>
      <li class="breadcrumb-item active">Software 3D Rendering in MAME</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="software-3d-rendering-in-mame">
<h1>Software 3D Rendering in MAME<a class="headerlink" href="#software-3d-rendering-in-mame" title="Link to this heading">Â¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id2">Background</a></p></li>
<li><p><a class="reference internal" href="#concepts" id="id3">Concepts</a></p>
<ul>
<li><p><a class="reference internal" href="#objecttype" id="id4">ObjectType</a></p></li>
<li><p><a class="reference internal" href="#primitives" id="id5">Primitives</a></p></li>
<li><p><a class="reference internal" href="#synchronization" id="id6">Synchronization</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-poly-manager-class" id="id7">The poly_manager class</a></p>
<ul>
<li><p><a class="reference internal" href="#types-constants" id="id8">Types &amp; Constants</a></p>
<ul>
<li><p><a class="reference internal" href="#vertex-t" id="id9">vertex_t</a></p></li>
<li><p><a class="reference internal" href="#extent-t" id="id10">extent_t</a></p></li>
<li><p><a class="reference internal" href="#render-delegate" id="id11">render_delegate</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#methods" id="id12">Methods</a></p>
<ul>
<li><p><a class="reference internal" href="#poly-manager" id="id13">poly_manager</a></p></li>
<li><p><a class="reference internal" href="#wait" id="id14">wait</a></p></li>
<li><p><a class="reference internal" href="#object-data" id="id15">object_data</a></p></li>
<li><p><a class="reference internal" href="#register-poly-array" id="id16">register_poly_array</a></p></li>
<li><p><a class="reference internal" href="#render-tile" id="id17">render_tile</a></p></li>
<li><p><a class="reference internal" href="#render-triangle" id="id18">render_triangle</a></p></li>
<li><p><a class="reference internal" href="#render-triangle-fan" id="id19">render_triangle_fan</a></p></li>
<li><p><a class="reference internal" href="#render-triangle-strip" id="id20">render_triangle_strip</a></p></li>
<li><p><a class="reference internal" href="#render-polygon" id="id21">render_polygon</a></p></li>
<li><p><a class="reference internal" href="#render-extents" id="id22">render_extents</a></p></li>
<li><p><a class="reference internal" href="#zclip-if-less" id="id23">zclip_if_less</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#example-renderer" id="id24">Example Renderer</a></p>
<ul>
<li><p><a class="reference internal" href="#types" id="id25">Types</a></p></li>
<li><p><a class="reference internal" href="#constructor" id="id26">Constructor</a></p></li>
<li><p><a class="reference internal" href="#swap-buffers" id="id27">swap_buffers</a></p></li>
<li><p><a class="reference internal" href="#clear-buffers" id="id28">clear_buffers</a></p></li>
<li><p><a class="reference internal" href="#draw-triangle" id="id29">draw_triangle</a></p></li>
<li><p><a class="reference internal" href="#draw-triangle-flat" id="id30">draw_triangle_flat</a></p></li>
<li><p><a class="reference internal" href="#draw-triangle-gouraud" id="id31">draw_triangle_gouraud</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#advanced-topic-the-poly-array-class" id="id32">Advanced Topic: the poly_array class</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id33">Methods</a></p>
<ul>
<li><p><a class="reference internal" href="#poly-array" id="id34">poly_array</a></p></li>
<li><p><a class="reference internal" href="#count" id="id35">count</a></p></li>
<li><p><a class="reference internal" href="#max" id="id36">max</a></p></li>
<li><p><a class="reference internal" href="#itemsize" id="id37">itemsize</a></p></li>
<li><p><a class="reference internal" href="#allocated" id="id38">allocated</a></p></li>
<li><p><a class="reference internal" href="#byindex" id="id39">byindex</a></p></li>
<li><p><a class="reference internal" href="#contiguous" id="id40">contiguous</a></p></li>
<li><p><a class="reference internal" href="#indexof" id="id41">indexof</a></p></li>
<li><p><a class="reference internal" href="#reset" id="id42">reset</a></p></li>
<li><p><a class="reference internal" href="#next" id="id43">next</a></p></li>
<li><p><a class="reference internal" href="#last" id="id44">last</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="background">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Background</a><a class="headerlink" href="#background" title="Link to this heading">Â¶</a></h2>
<p>Beginning in the late 1980s, many arcade games began incorporating hardware-rendered
3D graphics into their video. These 3D graphics are typically rendered from low-level
primitives into a frame buffer (usually double- or triple-buffered), then perhaps
combined with traditional tilemaps or sprites, before being presented to the player.</p>
<p>When it comes to emulating 3D games, there are two general approaches. The first
approach is to leverage modern 3D hardware by mapping the low-level primitives onto
modern equivalents. For a cross-platform emulator like MAME, this requires having an
API that is flexible enough to describe the primitives and all their associated
behaviors with high accuracy. It also requires the emulator to be able to read back
from the rendered frame buffer (since many games do this) and combine it with other
elements, in a way that is properly synchronized with background rendering.</p>
<p>The alternative approach is to render the low-level primitives directly in software.
This has the advantage of being able to achieve pretty much any behavior exhibited by
the original hardware, but at the cost of speed. In MAME, since all emulation happens
on one thread, this is particularly painful. However, just as with the 3D hardware
approach, in theory a software-based approach could be spun off to other threads to
handle the work, as long as mechanisms were present to synchronize when necessary,
for example, when reading/writing directly to/from the frame buffer.</p>
<p>For the time being, MAME has opted for the second approach, leveraging a templated
helper class called <strong>poly_manager</strong> to handle common situations.</p>
</section>
<section id="concepts">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Concepts</a><a class="headerlink" href="#concepts" title="Link to this heading">Â¶</a></h2>
<p>At its core, <strong>poly_manager</strong> is a mechanism to support multi-threaded rendering of
low-level 3D primitives. Callers provide <strong>poly_manager</strong> with a set of <em>vertices</em> for a
primitive plus a <em>render callback</em>. <strong>poly_manager</strong> breaks the primitive into
clipped scanline <em>extents</em> and distributes the work among a pool of <em>worker
threads</em>. The render callback is then called on the worker thread for each extent,
where game-specific logic can do whatever needs to happen to render the data.</p>
<p>One key responsibility that <strong>poly_manager</strong> takes care of is ensuring order. Given a
pool of threads and a number of work items to complete, it is important thatâat least
within a given scanlineâall work is performed serially in order. The basic approach is
to assign each extent to a <em>bucket</em> based on the Y coordinate. <strong>poly_manager</strong> then ensures
that only one worker thread at a time is responsible for processing work in a given bucket.</p>
<p>Vertices in <strong>poly_manager</strong> consist of simple 2D X and Y <em>coordinates</em>, plus zero or
more additional <em>iterated parameters</em>. These iterated parameters can be anything: intensity
values for lighting; RGB(A) colors for Gouraud shading; normalized U, V coordinates for
texture mapping; 1/Z values for Z buffering; etc. Iterated parameters, regardless of what
they represent, are interpolated linearly across the primitive in screen space and provided
as part of the extent to the render callback.</p>
<section id="objecttype">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">ObjectType</a><a class="headerlink" href="#objecttype" title="Link to this heading">Â¶</a></h3>
<p>When creating a <strong>poly_manager</strong> class, you must provide it a special type that you define,
known as <strong>ObjectType</strong>.</p>
<p>Because rendering happens asynchronously on worker threads, the idea is that the
<strong>ObjectType</strong> class will hold a snapshot of all the relevant data needed for rendering.
This allows the main thread to proceedâpotentially modifying some of the relevant stateâwhile
rendering happens elsewhere.</p>
<p>In theory, we could allocate a new <strong>ObjectType</strong> class for each primitive rendered;
however, that would be rather inefficient. It is quite common to set up the rendering
state and then render several primitives using the same state.</p>
<p>For this reason, <strong>poly_manager</strong> maintains an internal array of <strong>ObjectType</strong> objects and
keeps a copy of the last <strong>ObjectType</strong> used. Before submitting a new primitive, callers
can see if the rendering state has changed. If it has, it can ask <strong>poly_manager</strong> to allocate
a new <strong>ObjectType</strong> class and fill it in. When the primitive is submitted for rendering, the
most recently allocated <strong>ObjectType</strong> instance is implicitly captured and provided to the
render callbacks.</p>
<p>For more complex scenarios, where data might change even more infrequently, there is a
<strong>poly_array</strong> template, which can be used to manage data in a similar way. In fact,
internally <strong>poly_manager</strong> uses the <strong>poly_array</strong> class to manage its <strong>ObjectType</strong>
allocations. More information on the <strong>poly_array</strong> class is provided later.</p>
</section>
<section id="primitives">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Primitives</a><a class="headerlink" href="#primitives" title="Link to this heading">Â¶</a></h3>
<p><strong>poly_manager</strong> supports several different types of primitives:</p>
<ul class="simple">
<li><p>The most commonly-used primitive in <strong>poly_manager</strong> is the <em>triangle</em>, which has the
nice property that iterated parameters have constant deltas across the full surface.
Arbitrary-length <em>triangle fans</em> and <em>triangle strips</em> are also supported.</p></li>
<li><p>In addition to triangles, <strong>poly_manager</strong> also supports <em>polygons</em> with an arbitrary
number of vertices. The list of vertices is expected to be in either clockwise or
anticlockwise order. <strong>poly_manager</strong> will walk the edges to compute deltas across
each extent.</p></li>
<li><p>As a special case, <strong>poly_manager</strong> supports a <em>tile</em> primitive, which is a simple quad
defined by two vertices, a top-left vertex and a bottom-right vertex. Like triangles,
tiles have constant iterated parameter deltas across their surface.</p></li>
<li><p>Finally, <strong>poly_manager</strong> supports a fully custom mechanism where the caller provides
a list of extents that are more or less fed directly to the worker threads.
This is useful if emulating a system that has unusual primitives or requires highly
specific behaviors for its edges.</p></li>
</ul>
</section>
<section id="synchronization">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Synchronization</a><a class="headerlink" href="#synchronization" title="Link to this heading">Â¶</a></h3>
<p>One of the key requirements of providing an asynchronous rendering mechanism is
synchronization. Synchronization in <strong>poly_manager</strong> is super simple: just
call the <code class="docutils literal notranslate"><span class="pre">wait()</span></code> function.</p>
<p>There are several common reasons for issuing a wait:</p>
<ul class="simple">
<li><p>At display time, the pixel data must be copied to the screen. If any primitives were
queued which touch the portion of the display that is going to be shown, you need to
wait for rendering to be complete before copying. Note that this wait may not be
strictly necessary in some situations (for example, a triple-buffered system).</p></li>
<li><p>If the emulated system has a mechanism to read back from the framebuffer after
rendering, then a wait must be issued prior to the read in order to ensure that
asynchronous rendering is complete.</p></li>
<li><p>If the emulated system modifies any state that is not cached in the <strong>ObjectType</strong>
or elsewhere (for example, texture memory), then a wait must be issued to ensure
that pending primitives which might consume that state have finished their work.</p></li>
<li><p>If the emulated system can use a previous render target as, say, the texture source
for a new primitive, then submitting the second primitive must wait until the first
completes. <strong>poly_manager</strong> provides no internal mechanism to help detect this, so it
is on the caller to determine when or if this is necessary.</p></li>
</ul>
<p>Because the wait operation knows after it is done that all rendering is complete,
<strong>poly_manager</strong> also takes this opportunity to reclaim all memory allocated for its
internal structures, as well as memory allocated for <strong>ObjectType</strong> structures. Thus it is
important that you donât hang onto any <strong>ObjectType</strong> pointers after a wait is called.</p>
</section>
</section>
<section id="the-poly-manager-class">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">The poly_manager class</a><a class="headerlink" href="#the-poly-manager-class" title="Link to this heading">Â¶</a></h2>
<p>In most applications, <strong>poly_manager</strong> is not used directly, but rather serves as
the base class for a more complete rendering class. The <strong>poly_manager</strong> class
itself is a template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="n">BaseType</span><span class="p">,</span> <span class="k">class</span> <span class="nc">ObjectType</span><span class="p">,</span> <span class="nb">int</span> <span class="n">MaxParams</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">poly_manager</span><span class="p">;</span>
</pre></div>
</div>
<p>and the template parameters are:</p>
<ul class="simple">
<li><p><strong>BaseType</strong> is the type used internally for coordinates and iterated parameters, and
should generally be either <code class="docutils literal notranslate"><span class="pre">float</span></code> or <code class="docutils literal notranslate"><span class="pre">double</span></code>. In theory, a fixed-point integral
type could also be used, though the math logic has not been designed for that, so you
may encounter problems.</p></li>
<li><p><strong>ObjectType</strong> is the user-defined per-object data structure described above.
Internally, <strong>poly_manager</strong> will manage a <strong>poly_array</strong> of these, and a pointer to
the most-recently allocated one at the time a primitive is submitted will be implicitly
passed to the render callback for each corresponding extent.</p></li>
<li><p><strong>MaxParams</strong> is the maximum number of iterated parameters that may be specified in a
vertex. Iterated parameters are generic and treated identically, so the mapping of
parameter indices is completely up to the contract between the caller and the render
callback. It is permitted for <strong>MaxParams</strong> to be 0.</p></li>
<li><p><strong>Flags</strong> is zero or more of the following flags:</p>
<ul>
<li><p>POLY_FLAG_NO_WORK_QUEUE â specify this flag to disable asynchronous rendering; this
can be useful for debugging. When this option is enabled, all primitives are queued
and then processed in order on the calling thread when <code class="docutils literal notranslate"><span class="pre">wait()</span></code> is called on the
<strong>poly_manager</strong> class.</p></li>
<li><p>POLY_FLAG_NO_CLIPPING â specify this if you want <strong>poly_manager</strong> to skip its
internal clipping. Use this if your render callbacks do their own clipping, or if
the caller always handles clipping prior to submitting primitives.</p></li>
</ul>
</li>
</ul>
<section id="types-constants">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Types &amp; Constants</a><a class="headerlink" href="#types-constants" title="Link to this heading">Â¶</a></h3>
<section id="vertex-t">
<h4><a class="toc-backref" href="#id9" role="doc-backlink">vertex_t</a><a class="headerlink" href="#vertex-t" title="Link to this heading">Â¶</a></h4>
<p>Within the <strong>poly_manager</strong> class, youâll find a <strong>vertex_t</strong> type that describes a
single vertex. All primitive drawing methods accept 2 or more of these <strong>vertex_t</strong>
objects. The <strong>vertex_t</strong> includes the X and Y coordinates along with an array of
iterated parameter values at that vertex:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">vertex_t</span>
<span class="p">{</span>
    <span class="n">vertex_t</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">vertex_t</span><span class="p">(</span><span class="n">BaseType</span> <span class="n">_x</span><span class="p">,</span> <span class="n">BaseType</span> <span class="n">_y</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">BaseType</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>                          <span class="o">//</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="n">coordinates</span>
    <span class="n">std</span><span class="p">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">BaseType</span><span class="p">,</span> <span class="n">MaxParams</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">;</span>      <span class="o">//</span> <span class="n">iterated</span> <span class="n">parameters</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Note that <strong>vertex_t</strong> itself is defined in terms of the <strong>BaseType</strong> and <strong>MaxParams</strong>
template values of the owning <strong>poly_manager</strong> class.</p>
<p>All of <strong>poly_manager</strong>âs primitives operate in screen space, where (0,0) represents the
top-left corner of the top-left pixel, and (0.5,0.5) represents the center of that pixel.
Left and top pixel values are inclusive, while right and bottom pixel values are exclusive.</p>
<p>Thus, a <em>tile</em> rendered from (2,2)-(4,3) will completely cover 2 pixels: (2,2) and (3,2).</p>
<p>When calling a primitive drawing method, the iterated parameter array <strong>p</strong> need not be
completely filled out. The number of valid iterated parameter values is specified as a
template parameter to the primitive drawing methods, so only that many parameters need to
actually be populated in the <strong>vertex_t</strong> structures that are passed in.</p>
</section>
<section id="extent-t">
<h4><a class="toc-backref" href="#id10" role="doc-backlink">extent_t</a><a class="headerlink" href="#extent-t" title="Link to this heading">Â¶</a></h4>
<p><strong>poly_manager</strong> breaks primitives into extents, which are contiguous horizontal spans
contained within a single scanline. These extents are then distributed to worker threads,
who will call the render callback with information on how to render each extent. The
<strong>extent_t</strong> type describes one such extent, providing the bounding X coordinates along with
an array of iterated parameter start values and deltas across the span:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">extent_t</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">param_t</span>
    <span class="p">{</span>
        <span class="n">BaseType</span> <span class="n">start</span><span class="p">;</span>                     <span class="o">//</span> <span class="n">parameter</span> <span class="n">value</span> <span class="n">at</span> <span class="n">start</span>
        <span class="n">BaseType</span> <span class="n">dpdx</span><span class="p">;</span>                      <span class="o">//</span> <span class="n">dp</span><span class="o">/</span><span class="n">dx</span> <span class="n">relative</span> <span class="n">to</span> <span class="n">start</span>
    <span class="p">};</span>
    <span class="n">int16_t</span> <span class="n">startx</span><span class="p">,</span> <span class="n">stopx</span><span class="p">;</span>                  <span class="o">//</span> <span class="n">starting</span> <span class="p">(</span><span class="n">inclusive</span><span class="p">)</span><span class="o">/</span><span class="n">ending</span> <span class="p">(</span><span class="n">exclusive</span><span class="p">)</span> <span class="n">endpoints</span>
    <span class="n">std</span><span class="p">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">param_t</span><span class="p">,</span> <span class="n">MaxParams</span><span class="o">&gt;</span> <span class="n">param</span><span class="p">;</span>   <span class="o">//</span> <span class="n">array</span> <span class="n">of</span> <span class="n">parameter</span> <span class="n">start</span><span class="o">/</span><span class="n">deltas</span>
    <span class="n">void</span> <span class="o">*</span><span class="n">userdata</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">custom</span> <span class="n">per</span><span class="o">-</span><span class="n">span</span> <span class="n">data</span>
<span class="p">};</span>
</pre></div>
</div>
<p>For each iterated parameter, the <strong>start</strong> value contains the value at the left side of
the span. The <strong>dpdx</strong> value contains the change of the parameterâs value per X coordinate.</p>
<p>There is also a <strong>userdata</strong> field in the <strong>extent_t</strong> structure, which is not normally used,
except when performing custom rendering.</p>
</section>
<section id="render-delegate">
<h4><a class="toc-backref" href="#id11" role="doc-backlink">render_delegate</a><a class="headerlink" href="#render-delegate" title="Link to this heading">Â¶</a></h4>
<p>When rendering a primitive, in addition to the vertices, you must also provide a
<strong>render_delegate</strong> callback of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">render</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">ObjectType</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">)</span>
</pre></div>
</div>
<p>This callback is responsible for the actual rendering. It will be called at a later time,
likely on a different thread, for each extent. The parameters passed are:</p>
<ul class="simple">
<li><p><strong>y</strong> is the Y coordinate (scanline) of the current extent.</p></li>
<li><p><strong>extent</strong> is a reference to a <strong>extent_t</strong> structure, described above, which specifies for
this extent the start/stop X values along with the start/delta values for each iterated
parameter.</p></li>
<li><p><strong>object</strong> is a reference to the most recently allocated <strong>ObjectType</strong> at the time the
primitive was submitted for rendering; in theory it should contain most of not all of the
necessary data to perform rendering.</p></li>
<li><p><strong>threadid</strong> is a unique ID indicating the index of the thread youâre running on; this value
is useful if you are keeping any kind of statistics and donât want to add contention over
shared values. In this situation, you can allocate <strong>WORK_MAX_THREADS</strong> instances of your
data and update the instance for the <strong>threadid</strong> you are passed. When you want to display
the statistics, the main thread can accumulate and reset the data from all threads when itâs
safe to do so (e.g., after a wait).</p></li>
</ul>
</section>
</section>
<section id="methods">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Methods</a><a class="headerlink" href="#methods" title="Link to this heading">Â¶</a></h3>
<section id="poly-manager">
<h4><a class="toc-backref" href="#id13" role="doc-backlink">poly_manager</a><a class="headerlink" href="#poly-manager" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poly_manager</span><span class="p">(</span><span class="n">running_machine</span> <span class="o">&amp;</span><span class="n">machine</span><span class="p">);</span>
</pre></div>
</div>
<p>The <strong>poly_manager</strong> constructor takes just one parameter, a reference to the
<strong>running_machine</strong>. This grants <strong>poly_manager</strong> access to the work queues needed for
multithreaded running.</p>
</section>
<section id="wait">
<h4><a class="toc-backref" href="#id14" role="doc-backlink">wait</a><a class="headerlink" href="#wait" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">wait</span><span class="p">(</span><span class="n">char</span> <span class="n">const</span> <span class="o">*</span><span class="n">debug_reason</span> <span class="o">=</span> <span class="s2">&quot;general&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Calling <code class="docutils literal notranslate"><span class="pre">wait()</span></code> stalls the calling thread until all outstanding rendering is complete:</p>
<ul class="simple">
<li><p><strong>debug_reason</strong> is an optional parameter specifying the reason for the wait. It is
useful if the compile-time constant <strong>TRACK_POLY_WAITS</strong> is enabled, as it will print a
summary of wait times and reasons at the end of execution.</p></li>
</ul>
<p><strong>Return value:</strong> none.</p>
</section>
<section id="object-data">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">object_data</a><a class="headerlink" href="#object-data" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objectdata_array</span> <span class="o">&amp;</span><span class="n">object_data</span><span class="p">();</span>
</pre></div>
</div>
<p>This method just returns a reference to the internally-maintained <strong>poly_array</strong> of the
<strong>ObjectType</strong> you specified when creating <strong>poly_manager</strong>. For most applications, the
only interesting thing to do with this object is call the <code class="docutils literal notranslate"><span class="pre">next()</span></code> method to allocate
a new object to fill out.</p>
<p><strong>Return value:</strong> reference to a <strong>poly_array</strong> of <strong>ObjectType</strong>.</p>
</section>
<section id="register-poly-array">
<h4><a class="toc-backref" href="#id16" role="doc-backlink">register_poly_array</a><a class="headerlink" href="#register-poly-array" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">register_poly_array</span><span class="p">(</span><span class="n">poly_array_base</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">);</span>
</pre></div>
</div>
<p>For advanced applications, you may choose to create your own <strong>poly_array</strong> objects to
manage large chunks of infrequently-changed data, such a palettes. After each <code class="docutils literal notranslate"><span class="pre">wait()</span></code>,
<strong>poly_manager</strong> resets all the <strong>poly_array</strong> objects it knows about in order to reclaim all
outstanding allocated memory. By registering your <strong>poly_array</strong> objects here, you can ensure
that your arrays will also be reset after an <code class="docutils literal notranslate"><span class="pre">wait()</span></code> call.</p>
<p><strong>Return value:</strong> none.</p>
</section>
<section id="render-tile">
<h4><a class="toc-backref" href="#id17" role="doc-backlink">render_tile</a><a class="headerlink" href="#render-tile" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="n">uint32_t</span> <span class="n">render_tile</span><span class="p">(</span><span class="n">rectangle</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">cliprect</span><span class="p">,</span> <span class="n">render_delegate</span> <span class="n">callback</span><span class="p">,</span>
                     <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
</pre></div>
</div>
<p>This method enqueues a single <em>tile</em> primitive for rendering:</p>
<ul class="simple">
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>cliprect</strong> is a reference to a clipping rectangle. All pixels and parameter values are
clipped to stay within these bounds before being added to the work queues for rendering,
unless <strong>POLY_FLAG_NO_CLIPPING</strong> was specified as a flag parameter to <strong>poly_manager</strong>.</p></li>
<li><p><strong>callback</strong> is the render callback delegate that will be called to render each extent.</p></li>
<li><p><strong>v1</strong> contains the coordinates and iterated parameters for the top-left corner of the tile.</p></li>
<li><p><strong>v2</strong> contains the coordinates and iterated parameters for the bottom-right corner of the tile.</p></li>
</ul>
<p><strong>Return value:</strong> the total number of clipped pixels represented by the enqueued extents.</p>
</section>
<section id="render-triangle">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">render_triangle</a><a class="headerlink" href="#render-triangle" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="n">uint32_t</span> <span class="n">render_triangle</span><span class="p">(</span><span class="n">rectangle</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">cliprect</span><span class="p">,</span> <span class="n">render_delegate</span> <span class="n">callback</span><span class="p">,</span>
                         <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">);</span>
</pre></div>
</div>
<p>This method enqueues a single <em>triangle</em> primitive for rendering:</p>
<ul class="simple">
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>cliprect</strong> is a reference to a clipping rectangle. All pixels and parameter values are
clipped to stay within these bounds before being added to the work queues for rendering,
unless <strong>POLY_FLAG_NO_CLIPPING</strong> was specified as a flag parameter to <strong>poly_manager</strong>.</p></li>
<li><p><strong>callback</strong> is the render callback delegate that will be called to render each extent.</p></li>
<li><p><strong>v1</strong>, <strong>v2</strong>, <strong>v3</strong> contain the coordinates and iterated parameters for each vertex
of the triangle.</p></li>
</ul>
<p><strong>Return value:</strong> the total number of clipped pixels represented by the enqueued extents.</p>
</section>
<section id="render-triangle-fan">
<h4><a class="toc-backref" href="#id19" role="doc-backlink">render_triangle_fan</a><a class="headerlink" href="#render-triangle-fan" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="n">uint32_t</span> <span class="n">render_triangle_fan</span><span class="p">(</span><span class="n">rectangle</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">cliprect</span><span class="p">,</span> <span class="n">render_delegate</span> <span class="n">callback</span><span class="p">,</span>
                             <span class="nb">int</span> <span class="n">numverts</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
</pre></div>
</div>
<p>This method enqueues one or more <em>triangle</em> primitives for rendering, specified in fan order:</p>
<ul class="simple">
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>cliprect</strong> is a reference to a clipping rectangle. All pixels and parameter values are
clipped to stay within these bounds before being added to the work queues for rendering,
unless <strong>POLY_FLAG_NO_CLIPPING</strong> was specified as a flag parameter to <strong>poly_manager</strong>.</p></li>
<li><p><strong>callback</strong> is the render callback delegate that will be called to render each extent.</p></li>
<li><p><strong>numverts</strong> is the total number of vertices provided; it must be at least 3.</p></li>
<li><p><strong>v</strong> is a pointer to an array of <strong>vertex_t</strong> objects containing the coordinates and iterated
parameters for all the triangles, in fan order. This means that the first vertex is fixed.
So if 5 vertices are provided, indicating 3 triangles, the vertices used will be:
(0,1,2) (0,2,3) (0,3,4)</p></li>
</ul>
<p><strong>Return value:</strong> the total number of clipped pixels represented by the enqueued extents.</p>
</section>
<section id="render-triangle-strip">
<h4><a class="toc-backref" href="#id20" role="doc-backlink">render_triangle_strip</a><a class="headerlink" href="#render-triangle-strip" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="n">uint32_t</span> <span class="n">render_triangle_strip</span><span class="p">(</span><span class="n">rectangle</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">cliprect</span><span class="p">,</span> <span class="n">render_delegate</span> <span class="n">callback</span><span class="p">,</span>
                               <span class="nb">int</span> <span class="n">numverts</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
</pre></div>
</div>
<p>This method enqueues one or more <em>triangle</em> primitives for rendering, specified in strip order:</p>
<ul class="simple">
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>cliprect</strong> is a reference to a clipping rectangle. All pixels and parameter values are
clipped to stay within these bounds before being added to the work queues for rendering,
unless <strong>POLY_FLAG_NO_CLIPPING</strong> was specified as a flag parameter to <strong>poly_manager</strong>.</p></li>
<li><p><strong>callback</strong> is the render callback delegate that will be called to render each extent.</p></li>
<li><p><strong>numverts</strong> is the total number of vertices provided; it must be at least 3.</p></li>
<li><p><strong>v</strong> is a pointer to an array of <strong>vertex_t</strong> objects containing the coordinates and iterated
parameters for all the triangles, in strip order.
So if 5 vertices are provided, indicating 3 triangles, the vertices used will be:
(0,1,2) (1,2,3) (2,3,4)</p></li>
</ul>
<p><strong>Return value:</strong> the total number of clipped pixels represented by the enqueued extents.</p>
</section>
<section id="render-polygon">
<h4><a class="toc-backref" href="#id21" role="doc-backlink">render_polygon</a><a class="headerlink" href="#render-polygon" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">NumVerts</span><span class="p">,</span> <span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="n">uint32_t</span> <span class="n">render_polygon</span><span class="p">(</span><span class="n">rectangle</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">cliprect</span><span class="p">,</span> <span class="n">render_delegate</span> <span class="n">callback</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
</pre></div>
</div>
<p>This method enqueues a single <em>polygon</em> primitive for rendering:</p>
<ul class="simple">
<li><p><strong>NumVerts</strong> is the number of vertices in the polygon.</p></li>
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>cliprect</strong> is a reference to a clipping rectangle. All pixels and parameter values are
clipped to stay within these bounds before being added to the work queues for rendering,
unless <strong>POLY_FLAG_NO_CLIPPING</strong> was specified as a flag parameter to <strong>poly_manager</strong>.</p></li>
<li><p><strong>callback</strong> is the render callback delegate that will be called to render each extent.</p></li>
<li><p><strong>v</strong> is a pointer to an array of <strong>vertex_t</strong> objects containing the coordinates and iterated
parameters for the polygon. Vertices are assumed to be in either clockwise or anticlockwise
order.</p></li>
</ul>
<p><strong>Return value:</strong> the total number of clipped pixels represented by the enqueued extents.</p>
</section>
<section id="render-extents">
<h4><a class="toc-backref" href="#id22" role="doc-backlink">render_extents</a><a class="headerlink" href="#render-extents" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="n">uint32_t</span> <span class="n">render_extents</span><span class="p">(</span><span class="n">rectangle</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">cliprect</span><span class="p">,</span> <span class="n">render_delegate</span> <span class="n">callback</span><span class="p">,</span>
                        <span class="nb">int</span> <span class="n">startscanline</span><span class="p">,</span> <span class="nb">int</span> <span class="n">numscanlines</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">*</span><span class="n">extents</span><span class="p">);</span>
</pre></div>
</div>
<p>This method enqueues custom extents directly:</p>
<ul class="simple">
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>cliprect</strong> is a reference to a clipping rectangle. All pixels and parameter values are
clipped to stay within these bounds before being added to the work queues for rendering,
unless <strong>POLY_FLAG_NO_CLIPPING</strong> was specified as a flag parameter to <strong>poly_manager</strong>.</p></li>
<li><p><strong>callback</strong> is the render callback delegate that will be called to render each extent.</p></li>
<li><p><strong>startscanline</strong> is the Y coordinate of the first extent provided.</p></li>
<li><p><strong>numscanlines</strong> is the number of extents provided.</p></li>
<li><p><strong>extents</strong> is a pointer to an array of <strong>extent_t</strong> objects containing the start/stop
X coordinates and iterated parameters. The <strong>userdata</strong> field of the source extents is
copied to the target as well (this field is otherwise unused for all other types of
rendering).</p></li>
</ul>
<p><strong>Return value:</strong> the total number of clipped pixels represented by the enqueued extents.</p>
</section>
<section id="zclip-if-less">
<h4><a class="toc-backref" href="#id23" role="doc-backlink">zclip_if_less</a><a class="headerlink" href="#zclip-if-less" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="nb">int</span> <span class="n">ParamCount</span><span class="o">&gt;</span>
<span class="nb">int</span> <span class="n">zclip_if_less</span><span class="p">(</span><span class="nb">int</span> <span class="n">numverts</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="n">const</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">vertex_t</span> <span class="o">*</span><span class="n">outv</span><span class="p">,</span> <span class="n">BaseType</span> <span class="n">clipval</span><span class="p">);</span>
</pre></div>
</div>
<p>This method is a helper method to clip a polygon against a provided Z value. It assumes
that the first iterated parameter in <strong>vertex_t</strong> represents the Z coordinate. If any edge
crosses the Z plane represented by <strong>clipval</strong> that edge is clipped.</p>
<ul class="simple">
<li><p><strong>ParamCount</strong> is the number of live values in the iterated parameter array within each
<strong>vertex_t</strong> provided; it must be no greater than the <strong>MaxParams</strong> value specified in the
<strong>poly_manager</strong> template instantiation.</p></li>
<li><p><strong>numverts</strong> is the number of vertices in the input array.</p></li>
<li><p><strong>v</strong> is a pointer to the input array of <strong>vertex_t</strong> objects.</p></li>
<li><p><strong>outv</strong> is a pointer to the output array of <strong>vertex_t</strong> objects. <strong>v</strong> and <strong>outv</strong>
cannot overlap or point to the same memory.</p></li>
<li><p><strong>clipval</strong> is the value to compare parameter 0 against for clipping.</p></li>
</ul>
<p><strong>Return value:</strong> the number of output vertices written to <strong>outv</strong>.
Note that by design it is possible for this method to produce more vertices than the
input array, so callers should ensure there is enough room in the output buffer to
accommodate this.</p>
</section>
</section>
</section>
<section id="example-renderer">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">Example Renderer</a><a class="headerlink" href="#example-renderer" title="Link to this heading">Â¶</a></h2>
<p>Here is a complete example of how to create a software 3D renderer using <strong>poly_manager</strong>.
Our example renderer will only handle flat and Gouraud-shaded triangles with depth (Z)
buffering.</p>
<section id="types">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Types</a><a class="headerlink" href="#types" title="Link to this heading">Â¶</a></h3>
<p>The first thing we need to define is our <em>externally-visible</em> vertex format, which is distinct
from the internal <strong>vertex_t</strong> that <strong>poly_manager</strong> will define. In theory you could
use <strong>vertex_t</strong> directly, but the generic nature of <strong>poly_manager</strong>âs iterated parameters
make it awkward:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">example_vertex</span>
<span class="p">{</span>
    <span class="nb">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>      <span class="o">//</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="n">coordinates</span>
    <span class="n">rgb_t</span> <span class="n">color</span><span class="p">;</span>        <span class="o">//</span> <span class="n">color</span> <span class="n">at</span> <span class="n">this</span> <span class="n">vertex</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Next we define the <strong>ObjectType</strong> needed by <strong>poly_manager</strong>. For our simple case, we
define an <strong>example_object_data</strong> struct that consists of pointers to our rendering buffers,
plus a couple of fixed values that are consumed in some cases. More complex renderers would
typically have many more object-wide parameters defined here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">example_object_data</span>
<span class="p">{</span>
    <span class="n">bitmap_rgb32</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>    <span class="o">//</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">rendering</span> <span class="n">bitmap</span>
    <span class="n">bitmap_ind16</span> <span class="o">*</span><span class="n">depth</span><span class="p">;</span>   <span class="o">//</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">depth</span> <span class="n">bitmap</span>
    <span class="n">rgb_t</span> <span class="n">color</span><span class="p">;</span>           <span class="o">//</span> <span class="n">overall</span> <span class="n">color</span> <span class="p">(</span><span class="k">for</span> <span class="n">clearing</span> <span class="ow">and</span> <span class="n">flat</span> <span class="n">shaded</span> <span class="n">case</span><span class="p">)</span>
    <span class="n">uint16_t</span> <span class="n">depthval</span><span class="p">;</span>     <span class="o">//</span> <span class="n">fixed</span> <span class="n">depth</span> <span class="n">v</span> <span class="n">alue</span> <span class="p">(</span><span class="k">for</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now itâs time to define our renderer class, which we derive from <strong>poly_manager</strong>. As
template parameters we specify <code class="docutils literal notranslate"><span class="pre">float</span></code> as the base type for our data, since that will
be enough accuracy for this example, and we also provide our <strong>example_object_data</strong> as
the <strong>ObjectType</strong> class, plus the maximum number of iterated parameters our renderer
will ever need (4 in this case):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">example_renderer</span> <span class="p">:</span> <span class="n">public</span> <span class="n">poly_manager</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">,</span> <span class="n">example_object_data</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
    <span class="n">example_renderer</span><span class="p">(</span><span class="n">running_machine</span> <span class="o">&amp;</span><span class="n">machine</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">width</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">height</span><span class="p">);</span>

    <span class="n">bitmap_rgb32</span> <span class="o">*</span><span class="n">swap_buffers</span><span class="p">();</span>

    <span class="n">void</span> <span class="n">clear_buffers</span><span class="p">(</span><span class="n">rgb_t</span> <span class="n">color</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">depthval</span><span class="p">);</span>
    <span class="n">void</span> <span class="n">draw_triangle</span><span class="p">(</span><span class="n">example_vertex</span> <span class="n">const</span> <span class="o">*</span><span class="n">verts</span><span class="p">);</span>

<span class="n">private</span><span class="p">:</span>
    <span class="n">static</span> <span class="n">uint16_t</span> <span class="n">ooz_to_depthval</span><span class="p">(</span><span class="nb">float</span> <span class="n">ooz</span><span class="p">);</span>

    <span class="n">void</span> <span class="n">draw_triangle_flat</span><span class="p">(</span><span class="n">example_vertex</span> <span class="n">const</span> <span class="o">*</span><span class="n">verts</span><span class="p">);</span>
    <span class="n">void</span> <span class="n">draw_triangle_gouraud</span><span class="p">(</span><span class="n">example_vertex</span> <span class="n">const</span> <span class="o">*</span><span class="n">verts</span><span class="p">);</span>

    <span class="n">void</span> <span class="n">render_clear</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">example_object_data</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">);</span>
    <span class="n">void</span> <span class="n">render_flat</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">example_object_data</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">);</span>
    <span class="n">void</span> <span class="n">render_gouraud</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">example_object_data</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">);</span>

    <span class="nb">int</span> <span class="n">m_draw_buffer</span><span class="p">;</span>
    <span class="n">bitmap_rgb32</span> <span class="n">m_display</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">bitmap_ind16</span> <span class="n">m_depth</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="constructor">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Constructor</a><a class="headerlink" href="#constructor" title="Link to this heading">Â¶</a></h3>
<p>The constructor for our example renderer just initializes <strong>poly_manager</strong> and allocates
the rendering and depth buffers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">example_renderer</span><span class="p">::</span><span class="n">example_renderer</span><span class="p">(</span><span class="n">running_machine</span> <span class="o">&amp;</span><span class="n">machine</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">width</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">height</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">poly_manager</span><span class="p">(</span><span class="n">machine</span><span class="p">),</span>
    <span class="n">m_draw_buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">allocate</span> <span class="n">two</span> <span class="n">display</span> <span class="n">buffers</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">depth</span> <span class="n">buffer</span>
    <span class="n">m_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="n">m_display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="n">m_depth</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="swap-buffers">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">swap_buffers</a><a class="headerlink" href="#swap-buffers" title="Link to this heading">Â¶</a></h3>
<p>The first interesting method in our renderer is <code class="docutils literal notranslate"><span class="pre">swap_buffers()</span></code>, which returns a pointer to
the buffer weâve been drawing to, and sets up the other buffer as the new drawing target. The
idea is that the display update handler will call this method to get ahold of the bitmap to
display to the user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bitmap_rgb32</span> <span class="o">*</span><span class="n">example_renderer</span><span class="p">::</span><span class="n">swap_buffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">rendering</span> <span class="n">to</span> <span class="n">complete</span> <span class="n">before</span> <span class="n">returning</span> <span class="n">the</span> <span class="n">buffer</span>
    <span class="n">wait</span><span class="p">(</span><span class="s2">&quot;swap_buffers&quot;</span><span class="p">);</span>

    <span class="o">//</span> <span class="k">return</span> <span class="n">the</span> <span class="n">current</span> <span class="n">draw</span> <span class="n">buffer</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">switch</span> <span class="n">to</span> <span class="n">the</span> <span class="n">other</span>
    <span class="o">//</span> <span class="k">for</span> <span class="n">future</span> <span class="n">drawing</span>
    <span class="n">bitmap_rgb32</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_display</span><span class="p">[</span><span class="n">m_draw_buffer</span><span class="p">];</span>
    <span class="n">m_draw_buffer</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The most important thing here to note here is the call to <strong>poly_manager</strong>âs <code class="docutils literal notranslate"><span class="pre">wait()</span></code>, which
will block the current thread until all rendering is complete. This is important because
otherwise the caller may receive a bitmap that is still being drawn to, leading to torn
or corrupt visuals.</p>
</section>
<section id="clear-buffers">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">clear_buffers</a><a class="headerlink" href="#clear-buffers" title="Link to this heading">Â¶</a></h3>
<p>One of the most common operations to perform when doing 3D rendering is to initialize or
clear the display and depth buffers to a known value. This method below leverages
the <em>tile</em> primitive to render a rectangle over the screen by passing in (0,0) and (width,height)
for the two vertices.</p>
<p>Because the color and depth values to clear the buffer to are constant, they are stored in
a freshly-allocated <strong>example_object_data</strong> object, along with a pointer to the buffers in
question. The <code class="docutils literal notranslate"><span class="pre">render_tile()</span></code> call is made with a <code class="docutils literal notranslate"><span class="pre">&lt;0&gt;</span></code> suffix indicating that there are
no iterated parameters to worry about:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">clear_buffers</span><span class="p">(</span><span class="n">rgb_t</span> <span class="n">color</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">depthval</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">allocate</span> <span class="nb">object</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">populate</span> <span class="n">it</span> <span class="k">with</span> <span class="n">information</span> <span class="n">needed</span>
    <span class="n">example_object_data</span> <span class="o">&amp;</span><span class="nb">object</span> <span class="o">=</span> <span class="n">object_data</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_display</span><span class="p">[</span><span class="n">m_draw_buffer</span><span class="p">];</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_depth</span><span class="p">;</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">depthval</span> <span class="o">=</span> <span class="n">depthval</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">top</span><span class="p">,</span><span class="n">left</span> <span class="n">coordinate</span> <span class="ow">is</span> <span class="n">always</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vertex_t</span> <span class="n">topleft</span><span class="p">;</span>
    <span class="n">topleft</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">topleft</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">bottom</span><span class="p">,</span><span class="n">right</span> <span class="n">coordinate</span> <span class="ow">is</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">)</span>
    <span class="n">vertex_t</span> <span class="n">botright</span><span class="p">;</span>
    <span class="n">botright</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">m_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">();</span>
    <span class="n">botright</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">m_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">();</span>

    <span class="o">//</span> <span class="n">render</span> <span class="k">as</span> <span class="n">a</span> <span class="n">tile</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">iterated</span> <span class="n">parameters</span>
    <span class="n">render_tile</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cliprect</span><span class="p">(),</span>
                   <span class="n">render_delegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">example_renderer</span><span class="p">::</span><span class="n">render_clear</span><span class="p">,</span> <span class="n">this</span><span class="p">),</span>
                   <span class="n">topleft</span><span class="p">,</span> <span class="n">botright</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The render callback provided to <code class="docutils literal notranslate"><span class="pre">render_tile()</span></code> is also defined (privately) in our class,
and handles a single span. Note how the rendering parameters are extracted from the
<strong>example_object_data</strong> struct provided:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">render_clear</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">example_object_data</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">get</span> <span class="n">pointers</span> <span class="n">to</span> <span class="n">the</span> <span class="n">start</span> <span class="n">of</span> <span class="n">the</span> <span class="n">depth</span> <span class="n">buffer</span> <span class="ow">and</span> <span class="n">destination</span> <span class="n">scanlines</span>
    <span class="n">uint16_t</span> <span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nb">object</span><span class="o">.</span><span class="n">depth</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="n">uint32_t</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nb">object</span><span class="o">.</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">loop</span> <span class="n">over</span> <span class="n">the</span> <span class="n">full</span> <span class="n">extent</span> <span class="ow">and</span> <span class="n">just</span> <span class="n">store</span> <span class="n">the</span> <span class="n">constant</span> <span class="n">values</span> <span class="kn">from</span> <span class="nn">the</span> <span class="nb">object</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">startx</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">extent</span><span class="o">.</span><span class="n">stopx</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dest</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">color</span><span class="p">;</span>
        <span class="n">depth</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">depthval</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another important point to make is that the X coordinates provided by extent struct are
inclusive of startx but exclusive of stopx. Clipping is performed ahead of time so that
the render callback can focus on laying down pixels as quickly as possible with minimal
overhead.</p>
</section>
<section id="draw-triangle">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">draw_triangle</a><a class="headerlink" href="#draw-triangle" title="Link to this heading">Â¶</a></h3>
<p>Next up, we have our actual triangle rendering function, which will draw a single triangle
given an array of three vertices provided in the external <strong>example_vertex</strong> format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">draw_triangle</span><span class="p">(</span><span class="n">example_vertex</span> <span class="n">const</span> <span class="o">*</span><span class="n">verts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">flat</span> <span class="n">shaded</span> <span class="n">case</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">verts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">color</span> <span class="o">&amp;&amp;</span> <span class="n">verts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">verts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
        <span class="n">draw_triangle_flat</span><span class="p">(</span><span class="n">verts</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">draw_triangle_gouraud</span><span class="p">(</span><span class="n">verts</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Because it is simpler and faster to render a flat shaded triangle, the code checks to see
if the colors are the same on all three vertices. If they are, we call through to a special
flat-shaded case, otherwise we process it as a full Gouraud-shaded triangle.</p>
<p>This is a common technique to optimize rendering performance: identify special cases that
reduce the per-pixel work, and route them to separate render callbacks that are optimized
for that special case.</p>
</section>
<section id="draw-triangle-flat">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">draw_triangle_flat</a><a class="headerlink" href="#draw-triangle-flat" title="Link to this heading">Â¶</a></h3>
<p>Hereâs the setup code for rendering a flat-shaded triangle:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">draw_triangle_flat</span><span class="p">(</span><span class="n">example_vertex</span> <span class="n">const</span> <span class="o">*</span><span class="n">verts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">allocate</span> <span class="nb">object</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">populate</span> <span class="n">it</span> <span class="k">with</span> <span class="n">information</span> <span class="n">needed</span>
    <span class="n">example_object_data</span> <span class="o">&amp;</span><span class="nb">object</span> <span class="o">=</span> <span class="n">object_data</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_display</span><span class="p">[</span><span class="n">m_draw_buffer</span><span class="p">];</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_depth</span><span class="p">;</span>

    <span class="o">//</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">case</span> <span class="n">the</span> <span class="n">color</span> <span class="ow">is</span> <span class="n">constant</span> <span class="ow">and</span> <span class="n">specified</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">object</span> <span class="n">data</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">copy</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="ow">and</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="n">into</span> <span class="n">poly_manager</span> <span class="n">vertices</span>
    <span class="n">vertex_t</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">vertnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vertnum</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">vertnum</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span> <span class="o">/</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">render</span> <span class="n">the</span> <span class="n">triangle</span> <span class="k">with</span> <span class="mi">1</span> <span class="n">iterated</span> <span class="n">parameter</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">render_triangle</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cliprect</span><span class="p">(),</span>
                        <span class="n">render_delegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">example_renderer</span><span class="p">::</span><span class="n">render_flat</span><span class="p">,</span> <span class="n">this</span><span class="p">),</span>
                        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>First, we put the fixed color into the <strong>example_object_data</strong> directly, and then fill
out three <strong>vertex_t</strong> objects with the X and Y coordinates in the usual spot, and 1/Z
as our one and only iterated parameter. (We use 1/Z here because iterated parameters are
interpolated linearly in screen space. Z is not linear in screen space, but 1/Z is due to
perspective correction.)</p>
<p>Our flat-shaded case then calls <code class="docutils literal notranslate"><span class="pre">render_trangle</span></code> specifying <code class="docutils literal notranslate"><span class="pre">&lt;1&gt;</span></code> iterated parameter to
interpolate, and pointing to a special-case flat render callback:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">render_flat</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">example_object_data</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">get</span> <span class="n">pointers</span> <span class="n">to</span> <span class="n">the</span> <span class="n">start</span> <span class="n">of</span> <span class="n">the</span> <span class="n">depth</span> <span class="n">buffer</span> <span class="ow">and</span> <span class="n">destination</span> <span class="n">scanlines</span>
    <span class="n">uint16_t</span> <span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nb">object</span><span class="o">.</span><span class="n">depth</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="n">uint32_t</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nb">object</span><span class="o">.</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">starting</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">delta</span> <span class="n">per</span> <span class="n">X</span>
    <span class="nb">float</span> <span class="n">ooz</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">;</span>
    <span class="nb">float</span> <span class="n">doozdx</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dpdx</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">iterate</span> <span class="n">over</span> <span class="n">the</span> <span class="n">extent</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">startx</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">extent</span><span class="o">.</span><span class="n">stopx</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">convert</span> <span class="n">the</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="n">value</span> <span class="n">into</span> <span class="n">an</span> <span class="n">integral</span> <span class="n">depth</span> <span class="n">value</span>
        <span class="n">uint16_t</span> <span class="n">depthval</span> <span class="o">=</span> <span class="n">ooz_to_depthval</span><span class="p">(</span><span class="n">ooz</span><span class="p">);</span>

        <span class="o">//</span> <span class="k">if</span> <span class="n">closer</span> <span class="n">than</span> <span class="n">the</span> <span class="n">current</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">copy</span> <span class="n">the</span> <span class="n">color</span> <span class="ow">and</span> <span class="n">depth</span> <span class="n">value</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">depthval</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">dest</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">color</span><span class="p">;</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">depthval</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">regardless</span><span class="p">,</span> <span class="n">update</span> <span class="n">the</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">pixel</span>
        <span class="n">ooz</span> <span class="o">+=</span> <span class="n">doozdx</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This render callback is a bit more involved than the clearing case.</p>
<p>First, we have an iterated parameter (1/Z) to deal with, whose starting and X-delta
values we extract from the extent before the start of the inner loop.</p>
<p>Second, we perform depth buffer testing, using <code class="docutils literal notranslate"><span class="pre">ooz_to_depthval()</span></code> as a helper
to transform the floating-point 1/Z value into a 16-bit integer. We compare this value against
the current depth buffer value, and only store the pixel/depth value if itâs less.</p>
<p>At the end of each iteration, we advance the 1/Z value by the X-delta in preparation for the
next pixel.</p>
</section>
<section id="draw-triangle-gouraud">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">draw_triangle_gouraud</a><a class="headerlink" href="#draw-triangle-gouraud" title="Link to this heading">Â¶</a></h3>
<p>Finally we get to the code for the full-on Gouraud-shaded case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">draw_triangle_gouraud</span><span class="p">(</span><span class="n">example_vertex</span> <span class="n">const</span> <span class="o">*</span><span class="n">verts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">allocate</span> <span class="nb">object</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">populate</span> <span class="n">it</span> <span class="k">with</span> <span class="n">information</span> <span class="n">needed</span>
    <span class="n">example_object_data</span> <span class="o">&amp;</span><span class="nb">object</span> <span class="o">=</span> <span class="n">object_data</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_display</span><span class="p">[</span><span class="n">m_draw_buffer</span><span class="p">];</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_depth</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">copy</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span><span class="p">,</span> <span class="ow">and</span> <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span> <span class="n">into</span> <span class="n">poly_manager</span> <span class="n">vertices</span>
    <span class="n">vertex_t</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">vertnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vertnum</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">vertnum</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span> <span class="o">/</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">;</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">r</span><span class="p">();</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">g</span><span class="p">();</span>
        <span class="n">v</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">vertnum</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">b</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">render</span> <span class="n">the</span> <span class="n">triangle</span> <span class="k">with</span> <span class="mi">4</span> <span class="n">iterated</span> <span class="n">parameters</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
    <span class="n">render_triangle</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cliprect</span><span class="p">(),</span>
                        <span class="n">render_delegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">example_renderer</span><span class="p">::</span><span class="n">render_gouraud</span><span class="p">,</span> <span class="n">this</span><span class="p">),</span>
                        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here we have 4 iterated parameters: the 1/Z depth value, plus red, green, and blue,
stored as floating point values. We call <code class="docutils literal notranslate"><span class="pre">render_triangle()</span></code> with <code class="docutils literal notranslate"><span class="pre">&lt;4&gt;</span></code> as the
number of iterated parameters to process, and point to the full Gouraud render callback:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">example_renderer</span><span class="p">::</span><span class="n">render_gouraud</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent_t</span> <span class="n">const</span> <span class="o">&amp;</span><span class="n">extent</span><span class="p">,</span> <span class="n">example_object_data</span> <span class="n">const</span> <span class="o">&amp;</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span> <span class="n">threadid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="n">get</span> <span class="n">pointers</span> <span class="n">to</span> <span class="n">the</span> <span class="n">start</span> <span class="n">of</span> <span class="n">the</span> <span class="n">depth</span> <span class="n">buffer</span> <span class="ow">and</span> <span class="n">destination</span> <span class="n">scanlines</span>
    <span class="n">uint16_t</span> <span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nb">object</span><span class="o">.</span><span class="n">depth</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="n">uint32_t</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nb">object</span><span class="o">.</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">starting</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">delta</span> <span class="n">per</span> <span class="n">X</span>
    <span class="nb">float</span> <span class="n">ooz</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">;</span>
    <span class="nb">float</span> <span class="n">doozdx</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dpdx</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">starting</span> <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">delta</span> <span class="n">per</span> <span class="n">X</span> <span class="k">as</span> <span class="mf">8.24</span> <span class="n">fixed</span><span class="o">-</span><span class="n">point</span> <span class="n">values</span>
    <span class="n">uint32_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">uint32_t</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
    <span class="n">uint32_t</span> <span class="n">drdx</span> <span class="o">=</span> <span class="n">uint32_t</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dpdx</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
    <span class="n">uint32_t</span> <span class="n">g</span> <span class="o">=</span> <span class="n">uint32_t</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
    <span class="n">uint32_t</span> <span class="n">dgdx</span> <span class="o">=</span> <span class="n">uint32_t</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dpdx</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
    <span class="n">uint32_t</span> <span class="n">b</span> <span class="o">=</span> <span class="n">uint32_t</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
    <span class="n">uint32_t</span> <span class="n">dbdx</span> <span class="o">=</span> <span class="n">uint32_t</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">dpdx</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>

    <span class="o">//</span> <span class="n">iterate</span> <span class="n">over</span> <span class="n">the</span> <span class="n">extent</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">startx</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">extent</span><span class="o">.</span><span class="n">stopx</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">convert</span> <span class="n">the</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="n">value</span> <span class="n">into</span> <span class="n">an</span> <span class="n">integral</span> <span class="n">depth</span> <span class="n">value</span>
        <span class="n">uint16_t</span> <span class="n">depthval</span> <span class="o">=</span> <span class="n">ooz_to_depthval</span><span class="p">(</span><span class="n">ooz</span><span class="p">);</span>

        <span class="o">//</span> <span class="k">if</span> <span class="n">closer</span> <span class="n">than</span> <span class="n">the</span> <span class="n">current</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">assemble</span> <span class="n">the</span> <span class="n">color</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">depthval</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">dest</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb_t</span><span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">depthval</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">regardless</span><span class="p">,</span> <span class="n">update</span> <span class="n">the</span> <span class="mi">1</span><span class="o">/</span><span class="n">Z</span> <span class="ow">and</span> <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span> <span class="n">values</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">pixel</span>
        <span class="n">ooz</span> <span class="o">+=</span> <span class="n">doozdx</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">drdx</span><span class="p">;</span>
        <span class="n">g</span> <span class="o">+=</span> <span class="n">dgdx</span><span class="p">;</span>
        <span class="n">b</span> <span class="o">+=</span> <span class="n">dbdx</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This follows the same pattern as the flat-shaded callback, except we have 4 iterated parameters
to step through.</p>
<p>Note that even though the iterated parameters are of <code class="docutils literal notranslate"><span class="pre">float</span></code> type, we convert the
color values to fixed-point integers when iterating over them. This saves us doing 3
float-to-int conversions each pixel. The original RGB values were 0-255, so interpolation
can only produce values in the 0-255 range. Thus we can use 24 bits of a 32-bit integer as
the fraction, which is plenty accurate for this case.</p>
</section>
</section>
<section id="advanced-topic-the-poly-array-class">
<h2><a class="toc-backref" href="#id32" role="doc-backlink">Advanced Topic: the poly_array class</a><a class="headerlink" href="#advanced-topic-the-poly-array-class" title="Link to this heading">Â¶</a></h2>
<p><strong>poly_array</strong> is a template class that is used to manage a dynamically-sized vector of
objects whose lifetime starts at allocation and ends when <code class="docutils literal notranslate"><span class="pre">reset()</span></code> is called. The
<strong>poly_manager</strong> class uses several <strong>poly_array</strong> objects internally, including one for
allocated <strong>ObjectType</strong> data, one for each primitive rendered, and one for holding all
allocated extents.</p>
<p><strong>poly_array</strong> has an additional property where after a reset it retains a copy of the most
recently allocated object. This ensures that callers can always call <code class="docutils literal notranslate"><span class="pre">last()</span></code> and get
a valid object, even immediately after a reset.</p>
<p>The <strong>poly_array</strong> class requires two template parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ArrayType</span><span class="p">,</span> <span class="nb">int</span> <span class="n">TrackingCount</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">poly_array</span><span class="p">;</span>
</pre></div>
</div>
<p>These parameters are:</p>
<ul class="simple">
<li><p><strong>ArrayType</strong> is the type of object you wish to allocate and manage.</p></li>
<li><p><strong>TrackingCount</strong> is the number of objects you wish to preserve after a reset. Typically
this value is either 0 (you donât care to track any objects) or 1 (you only need one
object); however, if you are using <strong>poly_array</strong> to manage a shared collection of
objects across several independent consumers, it can be higher. See below for an example
where this might be handy.</p></li>
</ul>
<p>Note that objects allocated by <strong>poly_array</strong> are owned by <strong>poly_array</strong> and will be
automatically freed upon exit.</p>
<p><strong>poly_array</strong> is optimized for use in high frequency multi-threaded systems. Therefore,
one added feature of the class is that it rounds the allocation size of <strong>ArrayType</strong> to
the nearest cache line boundary, on the assumption that neighboring entries could be
accessed by different cores simultaneously. Keeping each <strong>ArrayType</strong> object in its
own cache line ensures no false sharing performance impacts.</p>
<p>Currently, <strong>poly_array</strong> has no mechanism to determine cache line size at runtime, so
it presumes that 64 bytes is a typical cache line size, which is true for most x64 and ARM
chips as of 2021. This value can be altered by changing the <strong>CACHE_LINE_SHIFT</strong> constant
defined at the top of the class.</p>
<p>Objects allocated by <strong>poly_array</strong> are created in 64k chunks. At construction time, one
chunkâs worth of objects is allocated up front. The chunk size is controlled by the
<strong>CHUNK_GRANULARITY</strong> constant defined at the top of the class.</p>
<p>As more objects are allocated, if <strong>poly_array</strong> runs out of space, it will dynamically
allocate more. This will produce discontiguous chunks of objects until the next <code class="docutils literal notranslate"><span class="pre">reset()</span></code>
call, at which point <strong>poly_array</strong> will reallocate all the objects into a contiguous
vector once again.</p>
<p>For the case where <strong>poly_array</strong> is used to manage a shared pool of objects, it can be
configured to retain multiple most recently allocated items by using a <strong>TrackingCount</strong>
greater than 1. For example, if <strong>poly_array</strong> is managing objects for two texture units,
then it can set <strong>TrackingCount</strong> equal to 2, and pass the index of the texture unit in
calls to <code class="docutils literal notranslate"><span class="pre">next()</span></code> and <code class="docutils literal notranslate"><span class="pre">last()</span></code>. After a reset, <strong>poly_array</strong> will remember the most
recently allocated object for each of the units independently.</p>
<section id="id1">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">Methods</a><a class="headerlink" href="#id1" title="Link to this heading">Â¶</a></h3>
<section id="poly-array">
<h4><a class="toc-backref" href="#id34" role="doc-backlink">poly_array</a><a class="headerlink" href="#poly-array" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poly_array</span><span class="p">();</span>
</pre></div>
</div>
<p>The <strong>poly_array</strong> constructor requires no parameters and simply pre-allocates one
chunk of objects in preparation for future allocations.</p>
</section>
<section id="count">
<h4><a class="toc-backref" href="#id35" role="doc-backlink">count</a><a class="headerlink" href="#count" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span> <span class="n">count</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Return value:</strong> the number of objects currently allocated.</p>
</section>
<section id="max">
<h4><a class="toc-backref" href="#id36" role="doc-backlink">max</a><a class="headerlink" href="#max" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span> <span class="nb">max</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Return value:</strong> the maximum number of objects ever allocated at one time.</p>
</section>
<section id="itemsize">
<h4><a class="toc-backref" href="#id37" role="doc-backlink">itemsize</a><a class="headerlink" href="#itemsize" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">size_t</span> <span class="n">itemsize</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Return value:</strong> the size of an object, rounded up to the nearest cache line boundary.</p>
</section>
<section id="allocated">
<h4><a class="toc-backref" href="#id38" role="doc-backlink">allocated</a><a class="headerlink" href="#allocated" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span> <span class="n">allocated</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Return value:</strong> the number of objects that fit within whatâs currently been allocated.</p>
</section>
<section id="byindex">
<h4><a class="toc-backref" href="#id39" role="doc-backlink">byindex</a><a class="headerlink" href="#byindex" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayType</span> <span class="o">&amp;</span><span class="n">byindex</span><span class="p">(</span><span class="n">u32</span> <span class="n">index</span><span class="p">);</span>
</pre></div>
</div>
<p>Returns a reference to an object in the array by index. Equivalent to [<strong>index</strong>] on a
normal array:</p>
<ul class="simple">
<li><p><strong>index</strong> is the index of the item you wish to reference.</p></li>
</ul>
<p><strong>Return value:</strong> a reference to the object in question. Since a reference is returned,
it is your responsibility to ensure that <strong>index</strong> is less than <code class="docutils literal notranslate"><span class="pre">count()</span></code> as there
is no mechanism to return an invalid result.</p>
</section>
<section id="contiguous">
<h4><a class="toc-backref" href="#id40" role="doc-backlink">contiguous</a><a class="headerlink" href="#contiguous" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayType</span> <span class="o">*</span><span class="n">contiguous</span><span class="p">(</span><span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">u32</span> <span class="o">&amp;</span><span class="n">chunk</span><span class="p">);</span>
</pre></div>
</div>
<p>Returns a pointer to the base of a contiguous section of <strong>count</strong> items starting at
<strong>index</strong>. Because <strong>poly_array</strong> dynamically resizes, it may not be possible to access
all <strong>count</strong> objects contiguously, so the number of actually contiguous items is
returned in <strong>chunk</strong>:</p>
<ul class="simple">
<li><p><strong>index</strong> is the index of the first item you wish to access contiguously.</p></li>
<li><p><strong>count</strong> is the number of items you wish to access contiguously.</p></li>
<li><p><strong>chunk</strong> is a reference to a variable that will be set to the actual number of
contiguous items available starting at <strong>index</strong>. If <strong>chunk</strong> is less than <strong>count</strong>,
then the caller should process the <strong>chunk</strong> items returned, then call <code class="docutils literal notranslate"><span class="pre">countiguous()</span></code>
again at (<strong>index</strong> + <strong>chunk</strong>) to access the rest.</p></li>
</ul>
<p><strong>Return value:</strong> a pointer to the first item in the contiguous chunk. No range checking
is performed, so it is your responsibility to ensure that <strong>index</strong> + <strong>count</strong> is less
than or equal to <code class="docutils literal notranslate"><span class="pre">count()</span></code>.</p>
</section>
<section id="indexof">
<h4><a class="toc-backref" href="#id41" role="doc-backlink">indexof</a><a class="headerlink" href="#indexof" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">indexof</span><span class="p">(</span><span class="n">ArrayType</span> <span class="o">&amp;</span><span class="n">item</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p>Returns the index within the array of the given item:</p>
<ul class="simple">
<li><p><strong>item</strong> is a reference to an item in the array.</p></li>
</ul>
<p><strong>Return value:</strong> the index of the item. It should always be the case that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="o">.</span><span class="n">indexof</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">byindex</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="o">==</span> <span class="n">index</span>
</pre></div>
</div>
</section>
<section id="reset">
<h4><a class="toc-backref" href="#id42" role="doc-backlink">reset</a><a class="headerlink" href="#reset" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">reset</span><span class="p">();</span>
</pre></div>
</div>
<p>Resets the <strong>poly_array</strong> by semantically deallocating all objects. If previous allocations
created a discontiguous array, a fresh vector is allocated at this time so that future
allocations up to the same level will remain contiguous.</p>
<p>Note that the <strong>ArrayType</strong> destructor is <em>not</em> called on objects as they are deallocated.</p>
<p><strong>Return value:</strong> none.</p>
</section>
<section id="next">
<h4><a class="toc-backref" href="#id43" role="doc-backlink">next</a><a class="headerlink" href="#next" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayType</span> <span class="o">&amp;</span><span class="nb">next</span><span class="p">(</span><span class="nb">int</span> <span class="n">tracking_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>Allocates a new object and returns a reference to it. If there is not enough space for
a new object in the current array, a new discontiguous array is created to hold it:</p>
<ul class="simple">
<li><p><strong>tracking_index</strong> is the tracking index you wish to assign the new item to. In the
common case this is 0, but could be non-zero if using a <strong>TrackingCount</strong> greater than 1.</p></li>
</ul>
<p><strong>Return value:</strong> a reference to the object. Note that the placement new operator is
called on this object, so the default <strong>ArrayType</strong> constructor will be invoked here.</p>
</section>
<section id="last">
<h4><a class="toc-backref" href="#id44" role="doc-backlink">last</a><a class="headerlink" href="#last" title="Link to this heading">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ArrayType</span> <span class="o">&amp;</span><span class="n">last</span><span class="p">(</span><span class="nb">int</span> <span class="n">tracking_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p>Returns a reference to the last object allocated:</p>
<ul class="simple">
<li><p><strong>tracking_index</strong> is the tracking index whose object you want. In the
common case this is 0, but could be non-zero if using a <strong>TrackingCount</strong> greater than 1.
<strong>poly_array</strong> remembers the most recently allocated object independently for each
<strong>tracking_index</strong>.</p></li>
</ul>
<p><strong>Return value:</strong> a reference to the last allocated object.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="uml_instructions.html" class="btn btn-neutral float-left" title="UML Instruction Reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="audio_effects.html" class="btn btn-neutral float-right" title="Audio effects" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1997-2025, MAMEdev and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>