<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAME Layout Scripting &mdash; MAME Documentation 0.284 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=14647ab7"></script>
        <script src="../_static/doctools.js?v=9bcbadda"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Object Finders" href="object_finders.html" />
    <link rel="prev" title="MAME Layout Files" href="layout_files.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MAME Documentation
          </a>
              <div class="version">
                0.284
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whatis.html">What is MAME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../healthwarning.html">Health Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../initialsetup/index.html">Getting MAME prepared</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usingmame/index.html">Basic MAME Usage and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commandline/index.html">MAME Command-line Usage and OS-Specific Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">Advanced configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugger/index.html">MAME Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../luascript/index.html">Lua Scripting Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">MAME External Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing to MAME</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Technical Specifications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="naming.html">MAME Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_files.html">MAME Layout Files</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">MAME Layout Scripting</a></li>
<li class="toctree-l2"><a class="reference internal" href="object_finders.html">Object Finders</a></li>
<li class="toctree-l2"><a class="reference internal" href="inputsystem.html">Input System</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_memory_interface.html">The device_memory_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_rom_interface.html">The device_rom_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_disasm_interface.html">The device_disasm_interface and the disassemblers</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_sound_interface.html">The device_sound_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Emulated system memory and address spaces management</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpu_device.html">CPU devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="floppy.html">The new floppy subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="nscsi.html">The new SCSI subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="m6502.html">The new 6502 family implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="uml_instructions.html">UML Instruction Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="poly_manager.html">Software 3D Rendering in MAME</a></li>
<li class="toctree-l2"><a class="reference internal" href="audio_effects.html">Audio effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="osd_audio.html">OSD audio support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">MAME and security concerns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">The MAME License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MAME Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Technical Specifications</a></li>
      <li class="breadcrumb-item active">MAME Layout Scripting</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mame-layout-scripting">
<span id="layscript"></span><h1>MAME Layout Scripting<a class="headerlink" href="#mame-layout-scripting" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#practical-examples" id="id2">Practical examples</a></p>
<ul>
<li><p><a class="reference internal" href="#espial-joystick-split-across-ports" id="id3">Espial: joystick split across ports</a></p></li>
<li><p><a class="reference internal" href="#star-wars-animation-on-two-axes" id="id4">Star Wars: animation on two axes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-layout-script-environment" id="id5">The layout script environment</a></p></li>
<li><p><a class="reference internal" href="#layout-events" id="id6">Layout events</a></p>
<ul>
<li><p><a class="reference internal" href="#layout-file-events" id="id7">Layout file events</a></p></li>
<li><p><a class="reference internal" href="#layout-view-events" id="id8">Layout view events</a></p></li>
<li><p><a class="reference internal" href="#layout-view-item-events" id="id9">Layout view item events</a></p></li>
<li><p><a class="reference internal" href="#layout-element-events" id="id10">Layout element events</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<span id="layscript-intro"></span><h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>MAME layout files can embed Lua script to provide enhanced functionality.
Although there’s a lot you can do with conditionally drawn components and
parameter animation, some things can only be done with scripting.  MAME uses an
event-based model.  Scripts can supply functions that will be called after
certain events, or when certain data is required.</p>
<p>Layout scripting requires the <a class="reference internal" href="../plugins/layout.html#plugins-layout"><span class="std std-ref">layout plugin</span></a> to be
enabled.  For example, to run BWB Double Take with the Lua script in the layout
enabled, you might use this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mame</span> <span class="o">-</span><span class="n">plugins</span> <span class="o">-</span><span class="n">plugin</span> <span class="n">layout</span> <span class="n">v4dbltak</span>
</pre></div>
</div>
<p>You may want to add the settings to enable the layout plugin to an INI file to
save having to enable it every time you start a system.  See <a class="reference internal" href="../plugins/index.html#plugins"><span class="std std-ref">Plugins</span></a> for
more information about using plugins with MAME.</p>
</section>
<section id="practical-examples">
<span id="layscript-examples"></span><h2><a class="toc-backref" href="#id2" role="doc-backlink">Practical examples</a><a class="headerlink" href="#practical-examples" title="Link to this heading">¶</a></h2>
<p>Before diving into the technical details of how it works, we’ll start with some
example layout files using Lua script for enhancement.  It’s assumed that you’re
familiar with MAME’s artwork system and have a basic understanding of Lua
scripting.  For details on MAME’s layout file, see <a class="reference internal" href="layout_files.html#layfile"><span class="std std-ref">MAME Layout Files</span></a>;  for detailed
descriptions of MAME’s Lua interface, see <a class="reference internal" href="../luascript/index.html#luascript"><span class="std std-ref">Lua Scripting Interface</span></a>.</p>
<section id="espial-joystick-split-across-ports">
<span id="layscript-examples-espial"></span><h3><a class="toc-backref" href="#id3" role="doc-backlink">Espial: joystick split across ports</a><a class="headerlink" href="#espial-joystick-split-across-ports" title="Link to this heading">¶</a></h3>
<p>Take a look at the player input definitions for Espial:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">PORT_START</span><span class="p">(</span><span class="s">&quot;IN1&quot;</span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_START1</span><span class="w"> </span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_START2</span><span class="w"> </span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_LEFT</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">PORT_8WAY</span><span class="w"> </span><span class="n">PORT_COCKTAIL</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_RIGHT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">PORT_8WAY</span><span class="w"> </span><span class="n">PORT_COCKTAIL</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_UP</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="n">PORT_8WAY</span><span class="w"> </span><span class="n">PORT_COCKTAIL</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_DOWN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">PORT_8WAY</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_DOWN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">PORT_8WAY</span><span class="w"> </span><span class="n">PORT_COCKTAIL</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_BUTTON2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">PORT_COCKTAIL</span>

<span class="n">PORT_START</span><span class="p">(</span><span class="s">&quot;IN2&quot;</span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_UNKNOWN</span><span class="w"> </span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_COIN1</span><span class="w"> </span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_UNKNOWN</span><span class="w"> </span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_RIGHT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">PORT_8WAY</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_UP</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="n">PORT_8WAY</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_BUTTON1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">PORT_COCKTAIL</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_BUTTON1</span><span class="w"> </span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="n">IP_ACTIVE_HIGH</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_JOYSTICK_LEFT</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">PORT_8WAY</span>
</pre></div>
</div>
<p>There are two joysticks, one used for both players on an upright cabinet or the
first player on a cocktail cabinet, and one used for the second player on a
cocktail cabinet.  Notice that the switches for the first joystick are split
across the two I/O ports.</p>
<p>There’s no layout file syntax to build the element state using bits from
multiple I/O ports.  It’s also inconvenient if each joystick needs to be defined
as a separate element because the bits for the switches aren’t arranged the same
way.</p>
<p>We can overcome these limitations using a script to read the player inputs and
set the items’ element state:</p>
<div class="highlight-XML notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;mamelayout</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- element for drawing a joystick --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- up = 1 (bit 0), down = 2 (bit 1), left = 4 (bit 2), right = 8 (bit 3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;stick&quot;</span><span class="w"> </span><span class="na">defstate=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x0&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_c.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x1&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_u.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x9&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_ur.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x8&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_r.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0xa&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_dr.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x2&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_d.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x6&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_dl.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x4&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_l.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;0x5&quot;</span><span class="w"> </span><span class="na">file=</span><span class="s">&quot;stick_ul.svg&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/element&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- we&#39;ll warn the user if the layout plugin isn&#39;t enabled --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- draw only when state is 1, and set the default state to 1 so warning is visible initially --&gt;</span>
<span class="w">    </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;warning&quot;</span><span class="w"> </span><span class="na">defstate=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;text</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">string=</span><span class="s">&quot;This view requires the layout plugin.&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/element&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- view showing the screen and joysticks on a cocktail cabinet --&gt;</span>
<span class="w">    </span><span class="nt">&lt;view</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Joystick Display&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- draw the screen with correct aspect ratio --&gt;</span>
<span class="w">        </span><span class="nt">&lt;screen</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;4&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/screen&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- first joystick, id attribute allows script to find item --&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- no bindings, state will be set by the script --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;joy_p1&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;stick&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- position below the screen --&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">xc=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">yc=</span><span class="s">&quot;3.35&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- second joystick, id attribute allows script to find item --&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- no bindings, state will be set by the script --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;joy_p2&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;stick&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- screen is flipped for second player, so rotate by 180 degrees --&gt;</span>
<span class="w">            </span><span class="nt">&lt;orientation</span><span class="w"> </span><span class="na">rotate=</span><span class="s">&quot;180&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- position above the screen --&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">xc=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">yc=</span><span class="s">&quot;-0.35&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- warning text item also has id attribute so the script can find it --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;warning&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;warning&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- position over the screen near the bottom --&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.2&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;2.6&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;3.6&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.2&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>
<span class="w">    </span><span class="nt">&lt;/view&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- the content of the script element will be called as a function by the layout plugin --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- use CDATA block to avoid the need to escape angle brackets and ampersands --&gt;</span>
<span class="w">    </span><span class="nt">&lt;script&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        -- file is the layout file object</span>
<span class="cp">        -- set a function to call after resolving tags</span>
<span class="cp">        file:set_resolve_tags_callback(</span>
<span class="cp">                function ()</span>
<span class="cp">                    -- file.device is the device that caused the layout to be loaded</span>
<span class="cp">                    -- in this case, it&#39;s the root machine driver for espial</span>
<span class="cp">                    -- look up the two I/O ports we need to be able to read</span>
<span class="cp">                    local in1 = file.device:ioport(&quot;IN1&quot;)</span>
<span class="cp">                    local in2 = file.device:ioport(&quot;IN2&quot;)</span>

<span class="cp">                    -- look up the view items for showing the joystick state</span>
<span class="cp">                    local p1_stick = file.views[&quot;Joystick Display&quot;].items[&quot;joy_p1&quot;]</span>
<span class="cp">                    local p2_stick = file.views[&quot;Joystick Display&quot;].items[&quot;joy_p2&quot;]</span>

<span class="cp">                    -- set a function to call before adding the view items to the render target</span>
<span class="cp">                    file.views[&quot;Joystick Display&quot;]:set_prepare_items_callback(</span>
<span class="cp">                            function ()</span>
<span class="cp">                                -- read the two player input I/O ports</span>
<span class="cp">                                local in1_val = in1:read()</span>
<span class="cp">                                local in2_val = in2:read()</span>

<span class="cp">                                -- set element state for first joystick</span>
<span class="cp">                                p1_stick:set_state(</span>
<span class="cp">                                        ((in2_val &amp; 0x10) &gt;&gt; 4) |   -- shift up from IN2 bit 4 to bit 0</span>
<span class="cp">                                        ((in1_val &amp; 0x20) &gt;&gt; 4) |   -- shift down from IN1 bit 5 to bit 1</span>
<span class="cp">                                        ((in2_val &amp; 0x80) &gt;&gt; 5) |   -- shift left from IN2 bit 7 to bit 2</span>
<span class="cp">                                        (in2_val &amp; 0x08))           -- right is in IN2 bit 3</span>

<span class="cp">                                -- set element state for second joystick</span>
<span class="cp">                                p2_stick:set_state(</span>
<span class="cp">                                        ((in1_val &amp; 0x10) &gt;&gt; 4) |   -- shift up from IN1 bit 4 to bit 0</span>
<span class="cp">                                        ((in1_val &amp; 0x40) &gt;&gt; 5) |   -- shift down from IN1 bit 6 to bit 1</span>
<span class="cp">                                        (in1_val &amp; 0x04) |          -- left is in IN1 bit 2</span>
<span class="cp">                                        (in1_val &amp; 0x08))           -- right is in IN1 bit 3</span>
<span class="cp">                            end)</span>

<span class="cp">                    -- hide the warning, since if we got here the script is running</span>
<span class="cp">                    file.views[&quot;Joystick Display&quot;].items[&quot;warning&quot;]:set_state(0)</span>
<span class="cp">                end)</span>
<span class="cp">    ]]&gt;</span><span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/mamelayout&gt;</span>
</pre></div>
</div>
<p>The layout has a <code class="docutils literal notranslate"><span class="pre">script</span></code> element containing the Lua script.  This is called
as a function by the layout plugin when the layout file is loaded.  The layout
views have been built at this point, but the emulated system has not finished
starting.  In particular, it’s not safe to access inputs and outputs at this
time.  The key variable in the script environment is <code class="docutils literal notranslate"><span class="pre">file</span></code>, which gives the
script access to its <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderlayfile"><span class="std std-ref">layout file</span></a>.</p>
<p>We supply a function to be called after tags in the layout file have been
resolved.  At this point, the emulated system will have completed starting.
This function does the following tasks:</p>
<ul class="simple">
<li><p>Looks up the two <a class="reference internal" href="../luascript/ref-input.html#luascript-ref-ioport"><span class="std std-ref">I/O ports</span></a> used for player
input.  I/O ports can be looked up by tag relative to the device that caused
the layout file to be loaded.</p></li>
<li><p>Looks up the two <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderlayitem"><span class="std std-ref">view items</span></a> used to
display joystick state.  Views can be looked up by name (i.e. value of the
<code class="docutils literal notranslate"><span class="pre">name</span></code> attribute), and items within a view can be looked up by ID (i.e. the
value of the <code class="docutils literal notranslate"><span class="pre">id</span></code> attribute).</p></li>
<li><p>Supplies a function to be called before view items are added to the render
target when drawing a frame.</p></li>
<li><p>Hides the warning that reminds the user to enable the layout plugin by setting
the element state for the item to 0 (the text component is only drawn when
the element state is 1).</p></li>
</ul>
<p>The function called before view items are added to the render target reads the
player inputs, and shuffles the bits into the order needed by the joystick
element.</p>
</section>
<section id="star-wars-animation-on-two-axes">
<span id="layscript-examples-starwars"></span><h3><a class="toc-backref" href="#id4" role="doc-backlink">Star Wars: animation on two axes</a><a class="headerlink" href="#star-wars-animation-on-two-axes" title="Link to this heading">¶</a></h3>
<p>We’ll make a layout that shows the position of the flight yoke for Atari Star
Wars.  The input ports are straightforward – each analog axis produces a value
in the range from 0x00 (0) to 0xff (255), inclusive:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">PORT_START</span><span class="p">(</span><span class="s">&quot;STICKY&quot;</span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_AD_STICK_Y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">PORT_SENSITIVITY</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span><span class="w"> </span><span class="n">PORT_KEYDELTA</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

<span class="n">PORT_START</span><span class="p">(</span><span class="s">&quot;STICKX&quot;</span><span class="p">)</span>
<span class="n">PORT_BIT</span><span class="p">(</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="n">IPT_AD_STICK_X</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">PORT_SENSITIVITY</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="n">PORT_KEYDELTA</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
<p>Here’s our layout file:</p>
<div class="highlight-XML notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;mamelayout</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- a square with a white outline 1% of its width --&gt;</span>
<span class="w">    </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;outline&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.00&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.00&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;1.00&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.00&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.99&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;1.00&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.00&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.00&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;1.00&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.99&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.00&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;1.00&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">    </span><span class="nt">&lt;/element&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- a rectangle with a vertical line 10% of its width down the middle --&gt;</span>
<span class="w">    </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;line&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- use a transparent rectangle to force element dimensions --&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;color</span><span class="w"> </span><span class="na">alpha=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/rect&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- this is the visible white line --&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.045&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">    </span><span class="nt">&lt;/element&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- an outlined square inset by 20% with lines 10% of the element width/height --&gt;</span>
<span class="w">    </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;box&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- use a transparent rectangle to force element dimensions --&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;color</span><span class="w"> </span><span class="na">alpha=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/rect&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- draw the outline of a square --&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.02&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.02&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.06&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.02&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.07&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.06&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.02&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.02&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.06&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">        </span><span class="nt">&lt;rect&gt;&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.07&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0.02&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.01&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.06&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/rect&gt;</span>
<span class="w">    </span><span class="nt">&lt;/element&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- we&#39;ll warn the user if the layout plugin isn&#39;t enabled --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- draw only when state is 1, and set the default state to 1 so warning is visible initially --&gt;</span>
<span class="w">    </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;warning&quot;</span><span class="w"> </span><span class="na">defstate=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;text</span><span class="w"> </span><span class="na">state=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">string=</span><span class="s">&quot;This view requires the layout plugin.&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/element&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- view showing the screen and flight yoke position --&gt;</span>
<span class="w">    </span><span class="nt">&lt;view</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Analog Control Display&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- draw the screen with correct aspect ratio --&gt;</span>
<span class="w">        </span><span class="nt">&lt;screen</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;4&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/screen&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- draw the white outlined square to the right of the screen near the bottom --&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- the script uses the size of this item to determine movement ranges --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;outline&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;outline&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;4.1&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;1.9&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;1.0&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;1.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- vertical line for displaying X axis input --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;vertical&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;line&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- element draws a vertical line, no need to rotate it --&gt;</span>
<span class="w">            </span><span class="nt">&lt;orientation</span><span class="w"> </span><span class="na">rotate=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- centre it in the square horizontally, using the full height --&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;4.55&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;1.9&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- horizontal line for displaying Y axis input --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;horizontal&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;line&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- rotate the element by 90 degrees to get a horizontal line --&gt;</span>
<span class="w">            </span><span class="nt">&lt;orientation</span><span class="w"> </span><span class="na">rotate=</span><span class="s">&quot;90&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- centre it in the square vertically, using the full width --&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;4.1&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;2.35&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- draw a small box at the intersection of the vertical and horizontal lines --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;box&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;box&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;4.55&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;2.35&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- draw the warning text over the screen near the bottom --&gt;</span>
<span class="w">        </span><span class="nt">&lt;element</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;warning&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;warning&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;bounds</span><span class="w"> </span><span class="na">x=</span><span class="s">&quot;0.2&quot;</span><span class="w"> </span><span class="na">y=</span><span class="s">&quot;2.6&quot;</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;3.6&quot;</span><span class="w"> </span><span class="na">height=</span><span class="s">&quot;0.2&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/element&gt;</span>
<span class="w">    </span><span class="nt">&lt;/view&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- the content of the script element will be called as a function by the layout plugin --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- use CDATA block to avoid the need to escape angle brackets and ampersands --&gt;</span>
<span class="w">    </span><span class="nt">&lt;script&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        -- file is the layout file object</span>
<span class="cp">        -- set a function to call after resolving tags</span>
<span class="cp">        file:set_resolve_tags_callback(</span>
<span class="cp">                function ()</span>
<span class="cp">                    -- file.device is the device that caused the layout to be loaded</span>
<span class="cp">                    -- in this case, it&#39;s the root machine driver for starwars</span>
<span class="cp">                    -- find the analog axis inputs</span>
<span class="cp">                    local x_input = file.device:ioport(&quot;STICKX&quot;)</span>
<span class="cp">                    local y_input = file.device:ioport(&quot;STICKY&quot;)</span>

<span class="cp">                    -- find the outline item</span>
<span class="cp">                    local outline_item = file.views[&quot;Analog Control Display&quot;].items[&quot;outline&quot;]</span>

<span class="cp">                    -- variables for keeping state across callbacks</span>
<span class="cp">                    local outline_bounds    -- bounds of the outlined square</span>
<span class="cp">                    local width, height     -- width and height for animated items</span>
<span class="cp">                    local x_scale, y_scale  -- ratios of axis units to render coordinates</span>
<span class="cp">                    local x_pos, y_pos      -- display positions for the animated items</span>

<span class="cp">                    -- set a function to call when view dimensions have been recalculated</span>
<span class="cp">                    -- this can happen when when the window is resized or scaling options are changed</span>
<span class="cp">                    file.views[&quot;Analog Control Display&quot;]:set_recomputed_callback(</span>
<span class="cp">                            function ()</span>
<span class="cp">                                -- get the bounds of the outlined square</span>
<span class="cp">                                outline_bounds = outline_item.bounds</span>
<span class="cp">                                -- animated items use 10% of the width/height of the square</span>
<span class="cp">                                width = outline_bounds.width * 0.1</span>
<span class="cp">                                height = outline_bounds.height * 0.1</span>
<span class="cp">                                -- calculate ratios of axis units to render coordinates</span>
<span class="cp">                                -- animated items leave 90% of the width/height for the movement range</span>
<span class="cp">                                -- the end of the range of each axis is at 0xff</span>
<span class="cp">                                x_scale = outline_bounds.width * 0.9 / 0xff</span>
<span class="cp">                                y_scale = outline_bounds.height * 0.9 / 0xff</span>
<span class="cp">                            end)</span>

<span class="cp">                    -- set a function to call before adding the view items to the render target</span>
<span class="cp">                    file.views[&quot;Analog Control Display&quot;]:set_prepare_items_callback(</span>
<span class="cp">                            function ()</span>
<span class="cp">                                -- read analog axes, reverse Y axis as zero is at the bottom</span>
<span class="cp">                                local x = x_input:read() &amp; 0xff</span>
<span class="cp">                                local y = 0xff - (y_input:read() &amp; 0xff)</span>
<span class="cp">                                -- convert the input values to layout coordinates</span>
<span class="cp">                                -- use the top left corner of the outlined square as the origin</span>
<span class="cp">                                x_pos = outline_bounds.x0 + (x * x_scale)</span>
<span class="cp">                                y_pos = outline_bounds.y0 + (y * y_scale)</span>
<span class="cp">                            end)</span>

<span class="cp">                    -- set a function to supply the bounds for the vertical line</span>
<span class="cp">                    file.views[&quot;Analog Control Display&quot;].items[&quot;vertical&quot;]:set_bounds_callback(</span>
<span class="cp">                            function ()</span>
<span class="cp">                                -- create a new render bounds object (starts as a unit square)</span>
<span class="cp">                                local result = emu.render_bounds()</span>
<span class="cp">                                -- set left, top, width and height</span>
<span class="cp">                                result:set_wh(</span>
<span class="cp">                                        x_pos,                  -- calculated X position for animated items</span>
<span class="cp">                                        outline_bounds.y0,      -- top of outlined square</span>
<span class="cp">                                        width,                  -- 10% of width of outlined square</span>
<span class="cp">                                        outline_bounds.height)  -- full height of outlined square</span>
<span class="cp">                                return result</span>
<span class="cp">                            end)</span>

<span class="cp">                    -- set a function to supply the bounds for the horizontal line</span>
<span class="cp">                    file.views[&quot;Analog Control Display&quot;].items[&quot;horizontal&quot;]:set_bounds_callback(</span>
<span class="cp">                            function ()</span>
<span class="cp">                                -- create a new render bounds object (starts as a unit square)</span>
<span class="cp">                                local result = emu.render_bounds()</span>
<span class="cp">                                -- set left, top, width and height</span>
<span class="cp">                                result:set_wh(</span>
<span class="cp">                                        outline_bounds.x0,      -- left of outlined square</span>
<span class="cp">                                        y_pos,                  -- calculated Y position for animated items</span>
<span class="cp">                                        outline_bounds.width,   -- full width of outlined square</span>
<span class="cp">                                        height)                 -- 10% of height of outlined square</span>
<span class="cp">                                return result</span>
<span class="cp">                            end)</span>

<span class="cp">                    -- set a function to supply the bounds for the box at the intersection of the lines</span>
<span class="cp">                    file.views[&quot;Analog Control Display&quot;].items[&quot;box&quot;]:set_bounds_callback(</span>
<span class="cp">                            function ()</span>
<span class="cp">                                -- create a new render bounds object (starts as a unit square)</span>
<span class="cp">                                local result = emu.render_bounds()</span>
<span class="cp">                                -- set left, top, width and height</span>
<span class="cp">                                result:set_wh(</span>
<span class="cp">                                        x_pos,                  -- calculated X position for animated items</span>
<span class="cp">                                        y_pos,                  -- calculated Y position for animated items</span>
<span class="cp">                                        width,                  -- 10% of width of outlined square</span>
<span class="cp">                                        height)                 -- 10% of height of outlined square</span>
<span class="cp">                                return result</span>
<span class="cp">                            end)</span>

<span class="cp">                    -- hide the warning, since if we got here the script is running</span>
<span class="cp">                    file.views[&quot;Analog Control Display&quot;].items[&quot;warning&quot;]:set_state(0)</span>
<span class="cp">                end)</span>
<span class="cp">    ]]&gt;</span><span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/mamelayout&gt;</span>
</pre></div>
</div>
<p>The layout has a <code class="docutils literal notranslate"><span class="pre">script</span></code> element containing the Lua script, to be called as a
function by the layout plugin when the layout file is loaded.  This happens
after the layout views have been build, but before the emulated system has
finished starting.  The <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderlayfile"><span class="std std-ref">layout file</span></a> object
is supplied to the script in the <code class="docutils literal notranslate"><span class="pre">file</span></code> variable.</p>
<p>We supply a function to be called after tags in the layout file have been
resolved.  This function does the following:</p>
<ul class="simple">
<li><p>Looks up the analog axis <a class="reference internal" href="../luascript/ref-input.html#luascript-ref-ioport"><span class="std std-ref">inputs</span></a>.</p></li>
<li><p>Looks up the <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderlayitem"><span class="std std-ref">view item</span></a> that draws the
outline of area where the yoke position is displayed.</p></li>
<li><p>Declares some variables to hold calculated values across function calls.</p></li>
<li><p>Supplies a function to be called when the view’s dimensions have been
recomputed.</p></li>
<li><p>Supplies a function to be called before adding view items to the render
container when drawing a frame.</p></li>
<li><p>Supplies functions that will supply the bounds for the animated items.</p></li>
<li><p>Hides the warning that reminds the user to enable the layout plugin by setting
the element state for the item to 0 (the text component is only drawn when
the element state is 1).</p></li>
</ul>
<p>The view is looked up by name (value of its <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute), and items
within the view are looked up by ID (values of their <code class="docutils literal notranslate"><span class="pre">id</span></code> attributes).</p>
<p>Layout view dimensions are recomputed in response to several events, including
the window being resized, entering/leaving full screen mode, toggling visibility
of item collections, and changing the zoom to screen area setting.  When this
happens, we need to update our size and animation scale factors.  We get the
bounds of the square where the yoke position is displayed, calculate the size
for the animated items, and calculate the ratios of axis units to render target
coordinates in each direction.  It’s more efficient to do these calculations
only when the results may change.</p>
<p>Before view items are added to the render target, we read the analog axis inputs
and convert the values to coordinates positions for the animated items.  The Y
axis input uses larger values to aim higher, so we need to reverse the value by
subtracting it from 0xff (255).  We add in the coordinates of the top left
corner of the square where we’re displaying the yoke position.  We do this once
each time the layout is drawn for efficiency, since we can use the values for
all three animated items.</p>
<p>Finally, we supply bounds for the animated items when required.  These functions
need to return <code class="docutils literal notranslate"><span class="pre">render_bounds</span></code> objects giving the position and size of the
items in render target coordinates.</p>
<p>(Since the vertical and horizontal line elements each only move on a single
axis, it would be possible to animate them using the layout file format’s item
animation features.  Only the box at the intersection of the line actually
requires scripting.  It’s done entirely using scripting here for illustrative
purposes.)</p>
</section>
</section>
<section id="the-layout-script-environment">
<span id="layscript-environment"></span><h2><a class="toc-backref" href="#id5" role="doc-backlink">The layout script environment</a><a class="headerlink" href="#the-layout-script-environment" title="Link to this heading">¶</a></h2>
<p>The Lua environment is provided by the layout plugin.  It’s fairly minimal, only
providing what’s needed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">file</span></code> giving the script’s <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderlayfile"><span class="std std-ref">layout file</span></a>
object.  Has a <code class="docutils literal notranslate"><span class="pre">device</span></code> property for obtaining the <a class="reference internal" href="../luascript/ref-devices.html#luascript-ref-device"><span class="std std-ref">device</span></a> that caused the layout file to be loaded, and a
<code class="docutils literal notranslate"><span class="pre">views</span></code> property for obtaining the layout’s <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderlayview"><span class="std std-ref">views</span></a> (indexed by name).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">machine</span></code> giving MAME’s current <a class="reference internal" href="../luascript/ref-core.html#luascript-ref-machine"><span class="std std-ref">running machine</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">emu.device_enumerator</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.palette_enumerator</span></code>,
<code class="docutils literal notranslate"><span class="pre">emu.screen_enumerator</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.cassette_enumerator</span></code>,
<code class="docutils literal notranslate"><span class="pre">emu.image_enumerator</span></code> and <code class="docutils literal notranslate"><span class="pre">emu.slot_enumerator</span></code> functions for obtaining
specific device interfaces.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">emu.attotime</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.render_bounds</span></code> and <code class="docutils literal notranslate"><span class="pre">emu.render_color</span></code> functions for
creating <a class="reference internal" href="../luascript/ref-core.html#luascript-ref-attotime"><span class="std std-ref">attotime</span></a>, <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-renderbounds"><span class="std std-ref">bounds</span></a> and <a class="reference internal" href="../luascript/ref-render.html#luascript-ref-rendercolor"><span class="std std-ref">colour</span></a>
objects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">emu.bitmap_ind8</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.bitmap_ind16</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.bitmap_ind32</span></code>,
<code class="docutils literal notranslate"><span class="pre">emu.bitmap_ind64</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.bitmap_yuy16</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.bitmap_rgb32</span></code> and
<code class="docutils literal notranslate"><span class="pre">emu.bitmap_argb32</span></code> objects for creating
<a class="reference internal" href="../luascript/ref-render.html#luascript-ref-bitmap"><span class="std std-ref">bitmaps</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">emu.print_verbose</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.print_error</span></code>, <code class="docutils literal notranslate"><span class="pre">emu.print_warning</span></code>,
<code class="docutils literal notranslate"><span class="pre">emu.print_info</span></code> and <code class="docutils literal notranslate"><span class="pre">emu.print_debug</span></code> functions for diagnostic output.</p></li>
<li><p>Standard Lua <code class="docutils literal notranslate"><span class="pre">tonumber</span></code>, <code class="docutils literal notranslate"><span class="pre">tostring</span></code>, <code class="docutils literal notranslate"><span class="pre">pairs</span></code> and <code class="docutils literal notranslate"><span class="pre">ipairs</span></code> functions,
and <code class="docutils literal notranslate"><span class="pre">math</span></code>, <code class="docutils literal notranslate"><span class="pre">table</span></code> and <code class="docutils literal notranslate"><span class="pre">string</span></code> objects for manipulating numbers,
strings, tables and other containers.</p></li>
<li><p>Standard Lua <code class="docutils literal notranslate"><span class="pre">print</span></code> function for text output to the console.</p></li>
</ul>
</section>
<section id="layout-events">
<span id="layscript-events"></span><h2><a class="toc-backref" href="#id6" role="doc-backlink">Layout events</a><a class="headerlink" href="#layout-events" title="Link to this heading">¶</a></h2>
<p>MAME layout scripting uses an event-based model.  Scripts can supply functions
to be called after events occur, or when data is needed.  There are three levels
of events: layout file events, layout view events, and layout view item events.</p>
<section id="layout-file-events">
<span id="layscript-events-file"></span><h3><a class="toc-backref" href="#id7" role="doc-backlink">Layout file events</a><a class="headerlink" href="#layout-file-events" title="Link to this heading">¶</a></h3>
<p>Layout file events apply to the file as a whole, and not to an individual view.</p>
<dl>
<dt>Resolve tags</dt><dd><p><code class="docutils literal notranslate"><span class="pre">file:set_resolve_tags_callback(cb)</span></code></p>
<p>Called after the emulated system has finished starting, input and output
tags in the layout have been resolved, and default item callbacks have been
set up.  This is a good time to look up inputs and set up view item event
handlers.</p>
<p>The callback function has no return value and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to remove the event handler.</p>
</dd>
</dl>
</section>
<section id="layout-view-events">
<span id="layscript-events-view"></span><h3><a class="toc-backref" href="#id8" role="doc-backlink">Layout view events</a><a class="headerlink" href="#layout-view-events" title="Link to this heading">¶</a></h3>
<p>Layout view events apply to an individual view.</p>
<dl>
<dt>Prepare items</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_prepare_items_callback(cb)</span></code></p>
<p>Called before the view’s items are added to the render target in preparation
for drawing a video frame.</p>
<p>The callback function has no return value and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to remove the event handler.</p>
</dd>
<dt>Preload</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_preload_callback(cb)</span></code></p>
<p>Called after pre-loading visible view elements.  This can happen when the
view is selected for the first time in a session, or when the user toggles
visibility of an element collection on.  Be aware that this can be called
multiple times in a session and avoid repeating expensive tasks.</p>
<p>The callback function has no return value and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to remove the event handler.</p>
</dd>
<dt>Dimensions recomputed</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_recomputed_callback(cb)</span></code></p>
<p>Called after view dimensions are recomputed.  This happens in several
situations, including the window being resized, entering or leaving full
screen mode, toggling visibility of item collections, and changes to the
rotation and zoom to screen area settings.  If you’re animating the position
of view items, this is a good time to calculate positions and scale factors.</p>
<p>The callback function has no return value and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to remove the event handler.</p>
</dd>
<dt>Pointer updated</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_pointer_updated_callback(cb)</span></code></p>
<p>Called when a pointer enters, moves or changes button state over the view.</p>
<p>The callback function is passed nine arguments:</p>
<ul class="simple">
<li><p>The pointer type as a string.  This will be <code class="docutils literal notranslate"><span class="pre">mouse</span></code>, <code class="docutils literal notranslate"><span class="pre">pen</span></code>, <code class="docutils literal notranslate"><span class="pre">touch</span></code>
or <code class="docutils literal notranslate"><span class="pre">unknown</span></code>, and will not change for the lifetime of a pointer.</p></li>
<li><p>The pointer ID.  This will be a non-negative integer that will not change
for the lifetime of a pointer.  Pointer ID values are recycled
aggressively.</p></li>
<li><p>The device ID.  This will be a non-negative integer that can be used to
group pointers for recognising multi-touch gestures.</p></li>
<li><p>The horizontal position of the pointer in layout coordinates.</p></li>
<li><p>The vertical position of the pointer in layout coordinates.</p></li>
<li><p>A bit mask representing the currently pressed buttons.  The primary button
is the least significant bit.</p></li>
<li><p>A bit mask representing the buttons that were pressed in this update.  The
primary button is the least significant bit.</p></li>
<li><p>A bit mask representing the buttons that were released in this update.
The primary button is the least significant bit.</p></li>
<li><p>The click count.  This is positive for multi-click actions, or negative if
a click is turned into a hold or drag.  This only applies to the primary
button.</p></li>
</ul>
<p>The callback function has no return value.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the
argument to remove the event handler.</p>
</dd>
<dt>Pointer left</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_pointer_left_callback(cb)</span></code></p>
<p>Called when a pointer leaves the view normally.  After receiving this event,
the pointer ID may be reused for a new pointer.</p>
<p>The callback function is passed seven arguments:</p>
<ul class="simple">
<li><p>The pointer type as a string.  This will be <code class="docutils literal notranslate"><span class="pre">mouse</span></code>, <code class="docutils literal notranslate"><span class="pre">pen</span></code>, <code class="docutils literal notranslate"><span class="pre">touch</span></code>
or <code class="docutils literal notranslate"><span class="pre">unknown</span></code>, and will not change for the lifetime of a pointer.</p></li>
<li><p>The pointer ID.  This will be a non-negative integer that will not change
for the lifetime of a pointer.  Pointer ID values are recycled
aggressively.</p></li>
<li><p>The device ID.  This will be a non-negative integer that can be used to
group pointers for recognising multi-touch gestures.</p></li>
<li><p>The horizontal position of the pointer in layout coordinates.</p></li>
<li><p>The vertical position of the pointer in layout coordinates.</p></li>
<li><p>A bit mask representing the buttons that were released in this update.
The primary button is the least significant bit.</p></li>
<li><p>The click count.  This is positive for multi-click actions, or negative if
a click is turned into a hold or drag.  This only applies to the primary
button.</p></li>
</ul>
<p>The callback function has no return value.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the
argument to remove the event handler.</p>
</dd>
<dt>Pointer aborted</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_pointer_aborted_callback(cb)</span></code></p>
<p>Called when a pointer leaves the view abnormally.  After receiving this
event, the pointer ID may be reused for a new pointer.</p>
<p>The callback function is passed seven arguments:</p>
<ul class="simple">
<li><p>The pointer type as a string.  This will be <code class="docutils literal notranslate"><span class="pre">mouse</span></code>, <code class="docutils literal notranslate"><span class="pre">pen</span></code>, <code class="docutils literal notranslate"><span class="pre">touch</span></code>
or <code class="docutils literal notranslate"><span class="pre">unknown</span></code>, and will not change for the lifetime of a pointer.</p></li>
<li><p>The pointer ID.  This will be a non-negative integer that will not change
for the lifetime of a pointer.  Pointer ID values are recycled
aggressively.</p></li>
<li><p>The device ID.  This will be a non-negative integer that can be used to
group pointers for recognising multi-touch gestures.</p></li>
<li><p>The horizontal position of the pointer in layout coordinates.</p></li>
<li><p>The vertical position of the pointer in layout coordinates.</p></li>
<li><p>A bit mask representing the buttons that were released in this update.
The primary button is the least significant bit.</p></li>
<li><p>The click count.  This is positive for multi-click actions, or negative if
a click is turned into a hold or drag.  This only applies to the primary
button.</p></li>
</ul>
<p>The callback function has no return value.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the
argument to remove the event handler.</p>
</dd>
<dt>Forget pointers</dt><dd><p><code class="docutils literal notranslate"><span class="pre">view:set_forget_pointers_callback(cb)</span></code></p>
<p>Called when the view should stop processing pointer input.  This can happen
in a number of situations, including:</p>
<ul class="simple">
<li><p>The user activated a menu.</p></li>
<li><p>The view configuration will change.</p></li>
<li><p>The view will be deactivated.</p></li>
</ul>
<p>The callback function has no return value and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to remove the event handler.</p>
</dd>
</dl>
</section>
<section id="layout-view-item-events">
<span id="layscript-events-item"></span><h3><a class="toc-backref" href="#id9" role="doc-backlink">Layout view item events</a><a class="headerlink" href="#layout-view-item-events" title="Link to this heading">¶</a></h3>
<p>Layout view item callbacks apply to individual items within a view.  They are
used to override items’ default element state, animation state, bounds and
colour behaviour.</p>
<dl>
<dt>Get element state</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_element_state_callback(cb)</span></code></p>
<p>Set callback for getting the item’s element state.  This controls how the
item’s element is drawn, for components that change appearance depending on
state, conditionally-drawn components, and component bounds/colour
animation.  Do not attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">element_state</span></code> property
from the callback, as it will result in infinite recursion.</p>
<p>The callback function must return an integer, and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore the default element state
handler (based on the item’s XML attributes).</p>
</dd>
<dt>Get animation state</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_animation_state_callback(cb)</span></code></p>
<p>Set callback for getting the item’s animation state.  This is used for item
bounds/colour animation.  Do not attempt to access the item’s
<code class="docutils literal notranslate"><span class="pre">animation_state</span></code> property from the callback, as it will result in
infinite recursion.</p>
<p>The callback function must return an integer, and takes no parameters.  Call
with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore the default animation state handler
(based on the item’s XML attributes and <code class="docutils literal notranslate"><span class="pre">animate</span></code> child element).</p>
</dd>
<dt>Get item bounds</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_bounds_callback(cb)</span></code></p>
<p>Set callback for getting the item’s bounds (position and size).  Do not
attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">bounds</span></code> property from the callback, as it
will result in infinite recursion.</p>
<p>The callback function must return a render bounds object representing the
item’s bounds in render target coordinates (usually created by calling
<code class="docutils literal notranslate"><span class="pre">emu.render_bounds</span></code>), and takes no parameters.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the
argument to restore the default bounds handler (based on the item’s
animation state and <code class="docutils literal notranslate"><span class="pre">bounds</span></code> child elements).</p>
</dd>
<dt>Get item colour</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_color_callback(cb)</span></code></p>
<p>Set callback for getting the item’s colour (the element texture’s colours
multiplied by this colour).  Do not attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">color</span></code>
property from the callback, as it will result in infinite recursion.</p>
<p>The callback function must return a render colour object representing the
ARGB colour (usually created by calling <code class="docutils literal notranslate"><span class="pre">emu.render_color</span></code>), and takes no
parameters.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore the default colour
handler (based on the item’s animation state and <code class="docutils literal notranslate"><span class="pre">color</span></code> child elements).</p>
</dd>
<dt>Get item horizontal scroll window size</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_scroll_size_x_callback(cb)</span></code></p>
<p>Set callback for getting the item’s horizontal scroll window size.  This
allows the script to control how much of the element is displayed by the
item.  Do not attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">scroll_size_x</span></code> property from
the callback, as it will result in infinite recursion.</p>
<p>The callback function must return a floating-point number representing the
horizontal window size as a proportion of the associated element’s width,
and takes no parameters.  A value of 1.0 will display the entire width of
the element; smaller values will display proportionally smaller parts of the
element.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore the default
horizontal scroll window size handler (based on the <code class="docutils literal notranslate"><span class="pre">xscroll</span></code> child
element).</p>
</dd>
<dt>Get item vertical scroll window size</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_scroll_size_y_callback(cb)</span></code></p>
<p>Set callback for getting the item’s vertical scroll window size.  This
allows the script to control how much of the element is displayed by the
item.  Do not attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">scroll_size_y</span></code> property from
the callback, as it will result in infinite recursion.</p>
<p>The callback function must return a floating-point number representing the
vertical window size as a proportion of the associated element’s height, and
takes no parameters.  A value of 1.0 will display the entire height of the
element; smaller values will display proportionally smaller parts of the
element.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore the default
vertical scroll window size handler (based on the <code class="docutils literal notranslate"><span class="pre">xscroll</span></code> child
element).</p>
</dd>
<dt>Get item horizontal scroll position</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_scroll_pos_x_callback(cb)</span></code></p>
<p>Set callback for getting the item’s horizontal scroll position.  This allows
the script to control which part of the element is displayed by the item.
Do not attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">scroll_pos_x</span></code> property from the
callback, as this will result in infinite recursion.</p>
<p>The callback must return a floating-point number, and takes no parameters.
A value of 0.0 aligns the left edge of the element with the left edge of the
item; larger values pan right.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore
the default horizontal scroll position handler (based on bindings in the
<code class="docutils literal notranslate"><span class="pre">xscroll</span></code> child element).</p>
</dd>
<dt>Get item vertical scroll position</dt><dd><p><code class="docutils literal notranslate"><span class="pre">item:set_scroll_pos_y_callback(cb)</span></code></p>
<p>Set callback for getting the item’s vertical scroll position.  This allows
the script to control which part of the element is displayed by the item.
Do not attempt to access the item’s <code class="docutils literal notranslate"><span class="pre">scroll_pos_y</span></code> property from the
callback, as this will result in infinite recursion.</p>
<p>The callback must return a floating-point number, and takes no parameters.
A value of 0.0 aligns the top edge of the element with the top edge of the
item; larger values pan down.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to restore
the default vertical scroll position handler (based on bindings in the
<code class="docutils literal notranslate"><span class="pre">yscroll</span></code> child element).</p>
</dd>
</dl>
</section>
<section id="layout-element-events">
<span id="layscript-events-element"></span><h3><a class="toc-backref" href="#id10" role="doc-backlink">Layout element events</a><a class="headerlink" href="#layout-element-events" title="Link to this heading">¶</a></h3>
<p>Layout element events apply to an individual visual element definition.</p>
<dl>
<dt>Draw</dt><dd><p><code class="docutils literal notranslate"><span class="pre">element:set_draw_callback(cb)</span></code></p>
<p>Set callback for additional drawing after the element’s components have been
drawn.  This gives the script direct control over the final texture when an
element item is drawn.</p>
<p>The callback is passed two arguments: the element state (an integer) and the
32-bit ARGB bitmap at the required size.  The callback must not attempt to
resize the bitmap.  Call with <code class="docutils literal notranslate"><span class="pre">nil</span></code> as the argument to remove the event
handler.</p>
</dd>
</dl>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="layout_files.html" class="btn btn-neutral float-left" title="MAME Layout Files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="object_finders.html" class="btn btn-neutral float-right" title="Object Finders" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1997-2025, MAMEdev and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>