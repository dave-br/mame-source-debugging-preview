<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Object Finders &mdash; MAME Documentation 0.278 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=be04ea20"></script>
        <script src="../_static/doctools.js?v=9bcbadda"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Input System" href="inputsystem.html" />
    <link rel="prev" title="MAME Layout Scripting" href="layout_script.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MAME Documentation
          </a>
              <div class="version">
                0.278
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whatis.html">What is MAME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../healthwarning.html">Health Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../initialsetup/index.html">Getting MAME prepared</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usingmame/index.html">Basic MAME Usage and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commandline/index.html">MAME Command-line Usage and OS-Specific Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">Advanced configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugger/index.html">MAME Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../luascript/index.html">Lua Scripting Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">MAME External Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing to MAME</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Technical Specifications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="naming.html">MAME Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_files.html">MAME Layout Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_script.html">MAME Layout Scripting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Object Finders</a></li>
<li class="toctree-l2"><a class="reference internal" href="inputsystem.html">Input System</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_memory_interface.html">The device_memory_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_rom_interface.html">The device_rom_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_disasm_interface.html">The device_disasm_interface and the disassemblers</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_sound_interface.html">The device_sound_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Emulated system memory and address spaces management</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpu_device.html">CPU devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="floppy.html">The new floppy subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="nscsi.html">The new SCSI subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="m6502.html">The new 6502 family implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="uml_instructions.html">UML Instruction Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="poly_manager.html">Software 3D Rendering in MAME</a></li>
<li class="toctree-l2"><a class="reference internal" href="audio_effects.html">Audio effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="osd_audio.html">OSD audio support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">MAME and security concerns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">The MAME License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MAME Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Technical Specifications</a></li>
      <li class="breadcrumb-item active">Object Finders</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="object-finders">
<h1>Object Finders<a class="headerlink" href="#object-finders" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#types-of-object-finder" id="id2">Types of object finder</a></p></li>
<li><p><a class="reference internal" href="#finding-resources" id="id3">Finding resources</a></p></li>
<li><p><a class="reference internal" href="#connections-between-devices" id="id4">Connections between devices</a></p></li>
<li><p><a class="reference internal" href="#object-finder-arrays" id="id5">Object finder arrays</a></p></li>
<li><p><a class="reference internal" href="#optional-object-finders" id="id6">Optional object finders</a></p>
<ul>
<li><p><a class="reference internal" href="#optional-system-components" id="id7">Optional system components</a></p></li>
<li><p><a class="reference internal" href="#optional-resources" id="id8">Optional resources</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#object-finder-types-in-more-detail" id="id9">Object finder types in more detail</a></p>
<ul>
<li><p><a class="reference internal" href="#device-finders" id="id10">Device finders</a></p></li>
<li><p><a class="reference internal" href="#memory-system-object-finders" id="id11">Memory system object finders</a></p></li>
<li><p><a class="reference internal" href="#i-o-port-finders" id="id12">I/O port finders</a></p></li>
<li><p><a class="reference internal" href="#address-space-finders" id="id13">Address space finders</a></p></li>
<li><p><a class="reference internal" href="#memory-pointer-finders" id="id14">Memory pointer finders</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#output-finders" id="id15">Output finders</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>Object finders are an important part of the glue MAME provides to tie the
devices that make up an emulated system together.  Object finders are used to
specify connections between devices, to efficiently access resources, and to
check that necessary resources are available on validation.</p>
<p>Object finders search for a target object by tag relative to a base device.
Some types of object finder require additional parameters.</p>
<p>Most object finders have required and optional versions.  The required versions
will raise an error if the target object is not found.  This will prevent a
device from starting or cause a validation error.  The optional versions will
log a verbose message if the target object is not found, and provide additional
members for testing whether the target object was found or not.</p>
<p>Object finder classes are declared in the header src/emu/devfind.h and have
Doxygen format API documentation.</p>
</section>
<section id="types-of-object-finder">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Types of object finder</a><a class="headerlink" href="#types-of-object-finder" title="Link to this heading">¶</a></h2>
<dl class="simple">
<dt>required_device&lt;DeviceClass&gt;, optional_device&lt;DeviceClass&gt;</dt><dd><p>Finds a device.  The template argument <code class="docutils literal notranslate"><span class="pre">DeviceClass</span></code> should be a class
derived from <code class="docutils literal notranslate"><span class="pre">device_t</span></code> or <code class="docutils literal notranslate"><span class="pre">device_interface</span></code>.</p>
</dd>
<dt>required_memory_region, optional_memory_region</dt><dd><p>Finds a memory region, usually from ROM definitions.  The target is the
<code class="docutils literal notranslate"><span class="pre">memory_region</span></code> object.</p>
</dd>
<dt>required_memory_bank, optional_memory_bank</dt><dd><p>Finds a memory bank instantiated in an address map.  The target is the
<code class="docutils literal notranslate"><span class="pre">memory_bank</span></code> object.</p>
</dd>
<dt>memory_bank_creator</dt><dd><p>Finds a memory bank instantiated in an address map, or creates it if it
doesn’t exist.  The target is the <code class="docutils literal notranslate"><span class="pre">memory_bank</span></code> object.  There is no
optional version, because the target object will always be found or
created.</p>
</dd>
<dt>required_ioport, optional_ioport</dt><dd><p>Finds an I/O port from a device’s input port definitions.  The target is the
<code class="docutils literal notranslate"><span class="pre">ioport_port</span></code> object.</p>
</dd>
<dt>required_address_space, optional_address_space</dt><dd><p>Finds a device’s address space.  The target is the <code class="docutils literal notranslate"><span class="pre">address_space</span></code> object.</p>
</dd>
<dt>required_region_ptr&lt;PointerType&gt;, optional_region_ptr&lt;PointerType&gt;</dt><dd><p>Finds the base pointer of a memory region, usually from ROM definitions.
The template argument <code class="docutils literal notranslate"><span class="pre">PointerType</span></code> is the target type (usually an
unsigned integer type).  The target is the first element in the memory
region.</p>
</dd>
<dt>required_shared_ptr&lt;PointerType&gt;, optional_shared_ptr&lt;PointerType&gt;</dt><dd><p>Finds the base pointer of a memory share instantiated in an address map.
The template argument <code class="docutils literal notranslate"><span class="pre">PointerType</span></code> is the target type (usually an
unsigned integer type).  The target is the first element in the memory
share.</p>
</dd>
<dt>memory_share_creator&lt;PointerType&gt;</dt><dd><p>Finds the base pointer of a memory share instantiated in an address map, or
creates it if it doesn’t exist.  The template argument <code class="docutils literal notranslate"><span class="pre">PointerType</span></code> is
the target type (usually an unsigned integer type).  The target is the first
element in the memory share.  There is no optional version, because the
target object will always be found or created.</p>
</dd>
</dl>
</section>
<section id="finding-resources">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Finding resources</a><a class="headerlink" href="#finding-resources" title="Link to this heading">¶</a></h2>
<p>We’ll start with a simple example of a device that uses object finders to access
its own child devices, inputs and ROM region.  The code samples here are based
on the Apple II Parallel Printer Interface card, but a lot of things have been
removed for clarity.</p>
<p>Object finders are declared as members of the device class:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">a2bus_parprn_device</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_t</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_a2bus_card_interface</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">a2bus_parprn_device</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">);</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">write_c0nx</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="nf">read_cnxx</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">tiny_rom_entry</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">device_rom_region</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">device_add_mconfig</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">ioport_constructor</span><span class="w"> </span><span class="nf">device_input_ports</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">required_device</span><span class="o">&lt;</span><span class="n">centronics_device</span><span class="o">&gt;</span><span class="w">      </span><span class="n">m_printer_conn</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_device</span><span class="o">&lt;</span><span class="n">output_latch_device</span><span class="o">&gt;</span><span class="w">    </span><span class="n">m_printer_out</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_ioport</span><span class="w">                         </span><span class="n">m_input_config</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_region_ptr</span><span class="o">&lt;</span><span class="n">u8</span><span class="o">&gt;</span><span class="w">                 </span><span class="n">m_prom</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>We want to find a <code class="docutils literal notranslate"><span class="pre">centronics_device</span></code>, an <code class="docutils literal notranslate"><span class="pre">output_latch_device</span></code>, an I/O
port, and an 8-bit memory region.</p>
<p>In the constructor, we set the initial target for the object finders:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">a2bus_parprn_device</span><span class="o">::</span><span class="n">a2bus_parprn_device</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">    </span><span class="n">device_t</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">A2BUS_PARPRN</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">),</span>
<span class="w">    </span><span class="n">device_a2bus_card_interface</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_printer_conn</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;prn&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_printer_out</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;prn_out&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_input_config</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CFG&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_prom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;prom&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each object finder takes a base device and tag as constructor arguments.  The
base device supplied at construction serves two purposes.  Most obviously, the
tag is specified relative to this device.  Possibly more importantly, the object
finder registers itself with this device so that it will be called to perform
validation and object resolution.</p>
<p>Note that the object finders <em>do not</em> copy the tag strings.  The caller must
ensure the tag string remains valid until after validation and/or object
resolution is complete.</p>
<p>The memory region and I/O port come from the ROM definition and input
definition, respectively:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="p">{</span>

<span class="n">ROM_START</span><span class="p">(</span><span class="n">parprn</span><span class="p">)</span>
<span class="w">    </span><span class="n">ROM_REGION</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;prom&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">ROM_LOAD</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;prom.b4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0100</span><span class="p">,</span><span class="w"> </span><span class="n">BAD_DUMP</span><span class="w"> </span><span class="n">CRC</span><span class="p">(</span><span class="mo">00</span><span class="n">b742ca</span><span class="p">)</span><span class="w"> </span><span class="n">SHA1</span><span class="p">(</span><span class="n">c67888354aa013f9cb882eeeed924e292734e717</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="n">ROM_END</span>

<span class="n">INPUT_PORTS_START</span><span class="p">(</span><span class="n">parprn</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_START</span><span class="p">(</span><span class="s">&quot;CFG&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFNAME</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Acknowledge latching edge&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Falling (/Y-B)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Rising (Y-B)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFNAME</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Printer ready&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Always (S5-C-D)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Acknowledge latch (Z-C-D)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ACK (Y-C-D)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/ACK (/Y-C-D)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFNAME</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Strobe polarity&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Negative (S5-A-/X, GND-X)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Positive (S5-X, GND-A-/X)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFNAME</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Character width&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;7-bit&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">PORT_CONFSETTING</span><span class="p">(</span><span class="w">   </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8-bit&quot;</span><span class="p">)</span>
<span class="n">INPUT_PORTS_END</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// anonymous namespace</span>

<span class="n">tiny_rom_entry</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">a2bus_parprn_device</span><span class="o">::</span><span class="n">device_rom_region</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ROM_NAME</span><span class="p">(</span><span class="n">parprn</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ioport_constructor</span><span class="w"> </span><span class="n">a2bus_parprn_device</span><span class="o">::</span><span class="n">device_input_ports</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">INPUT_PORTS_NAME</span><span class="p">(</span><span class="n">parprn</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the tags <code class="docutils literal notranslate"><span class="pre">&quot;prom&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;CFG&quot;</span></code> match the tags passed to the object
finders on construction.</p>
<p>Child devices are instantiated in the device’s machine configuration member
function:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">a2bus_parprn_device::device_add_mconfig</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CENTRONICS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">m_printer_conn</span><span class="p">,</span><span class="w"> </span><span class="n">centronics_devices</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;printer&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_printer_conn</span><span class="o">-&gt;</span><span class="n">ack_handler</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="n">FUNC</span><span class="p">(</span><span class="n">a2bus_parprn_device</span><span class="o">::</span><span class="n">ack_w</span><span class="p">));</span>

<span class="w">    </span><span class="n">OUTPUT_LATCH</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">m_printer_out</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_printer_conn</span><span class="o">-&gt;</span><span class="n">set_output_latch</span><span class="p">(</span><span class="o">*</span><span class="n">m_printer_out</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Object finders are passed to device types to provide tags when instantiating
child devices.  After instantiating a child device in this way, the object
finder can be used like a pointer to the device until the end of the machine
configuration member function.  Note that to use an object finder like this,
its base device must be the same as the device being configured (the <code class="docutils literal notranslate"><span class="pre">this</span></code>
pointer of the machine configuration member function).</p>
<p>After the emulated machine has been started, the object finders can be used in
much the same way as pointers:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">a2bus_parprn_device::write_c0nx</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ioport_value</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">cfg</span><span class="p">(</span><span class="n">m_input_config</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">());</span>

<span class="w">    </span><span class="n">m_printer_out</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0xffU</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0x7fU</span><span class="p">));</span>
<span class="w">    </span><span class="n">m_printer_conn</span><span class="o">-&gt;</span><span class="n">write_strobe</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="o">~</span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>


<span class="n">u8</span><span class="w"> </span><span class="nf">a2bus_parprn_device::read_cnxx</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">offset</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x40U</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_prom</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For convenience, object finders that target the base pointer of memory regions
and shares can be indexed like arrays.</p>
</section>
<section id="connections-between-devices">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Connections between devices</a><a class="headerlink" href="#connections-between-devices" title="Link to this heading">¶</a></h2>
<p>Devices need to be connected together within a system.  For example the Sun SBus
device needs access to the host CPU and address space.  Here’s how we declare
the object finders in the device class (with all distractions removed):</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">DECLARE_DEVICE_TYPE</span><span class="p">(</span><span class="n">SBUS</span><span class="p">,</span><span class="w"> </span><span class="n">sbus_device</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">sbus_device</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_t</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_memory_interface</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">U</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">sbus_device</span><span class="p">(</span>
<span class="w">            </span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">,</span>
<span class="w">            </span><span class="n">T</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">cpu_tag</span><span class="p">,</span>
<span class="w">            </span><span class="n">U</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">space_tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">space_num</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">sbus_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">set_cpu</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu_tag</span><span class="p">));</span>
<span class="w">        </span><span class="n">set_type1space</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">space_tag</span><span class="p">),</span><span class="w"> </span><span class="n">space_num</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sbus_device</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">device_t</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">SBUS</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">),</span>
<span class="w">        </span><span class="n">device_memory_interface</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_maincpu</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_type1space</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_cpu</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">m_maincpu</span><span class="p">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_type1space</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">m_type1space</span><span class="p">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">required_device</span><span class="o">&lt;</span><span class="n">sparc_base_device</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_maincpu</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_address_space</span><span class="w"> </span><span class="n">m_type1space</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>There are several things to take note of here:</p>
<ul class="simple">
<li><p>Object finder members are declared for the things the device needs to access.</p></li>
<li><p>The device doesn’t know how it will fit into a larger system, the object
finders are constructed with dummy arguments.</p></li>
<li><p>Configuration member functions are provided to set the tag for the host CPU,
and the tag and index for the type 1 address space.</p></li>
<li><p>In addition to the standard device constructor, a constructor with additional
parameters for setting the CPU and type 1 address space is provided.</p></li>
</ul>
<p>The constant <code class="docutils literal notranslate"><span class="pre">finder_base::DUMMY_TAG</span></code> is guaranteed to be invalid and will not
resolve to an object.  This makes it easy to detect incomplete configuration and
report an error.  Address spaces are numbered from zero, so a negative address
space number is invalid.</p>
<p>The member functions for configuring object finders take a universal reference
to a tag-like object (templated type with <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code> qualifier), as well as any
other parameters needed by the specific type of object finder.  An address space
finder needs an address space number in addition to a tag-like object.</p>
<p>So what’s a tag-like object?  Three things are supported:</p>
<ul class="simple">
<li><p>A C string pointer (<code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">const</span> <span class="pre">*</span></code>) representing a tag relative to the
device being configured.  Note that the object finder will not copy the
string.  The caller must ensure it remains valid until resolution and/or
validation is complete.</p></li>
<li><p>Another object finder.  The object finder will take on its current target.</p></li>
<li><p>For device finders, a reference to an instance of the target device type,
setting the target to that device.  Note that this will not work if the device
is subsequently replaced in the machine configuration.  It’s most often used
with <code class="docutils literal notranslate"><span class="pre">*this</span></code>.</p></li>
</ul>
<p>The additional constructor that sets initial configuration delegates to the
standard constructor and then calls the configuration member functions.  It’s
purely for convenience.</p>
<p>When we want to instantiate this device and hook it up, we do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPARCV7</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">m_maincpu</span><span class="p">,</span> <span class="mi">20</span><span class="s1">&#39;000&#39;</span><span class="mi">000</span><span class="p">);</span>

<span class="n">ADDRESS_MAP_BANK</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">m_type1space</span><span class="p">);</span>

<span class="n">SBUS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">m_sbus</span><span class="p">,</span> <span class="mi">20</span><span class="s1">&#39;000&#39;</span><span class="mi">000</span><span class="p">);</span>
<span class="n">m_sbus</span><span class="o">-&gt;</span><span class="n">set_cpu</span><span class="p">(</span><span class="n">m_maincpu</span><span class="p">);</span>
<span class="n">m_sbus</span><span class="o">-&gt;</span><span class="n">set_type1space</span><span class="p">(</span><span class="n">m_type1space</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>We supply the same object finders to instantiate the CPU and address space
devices, and to configure the SBus device.</p>
<p>Note that we could also use literal C strings to configure the SBus device, at
the cost of needing to update the tags in multiple places if they change:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SBUS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">m_sbus</span><span class="p">,</span> <span class="mi">20</span><span class="s1">&#39;000&#39;</span><span class="mi">000</span><span class="p">);</span>
<span class="n">m_sbus</span><span class="o">-&gt;</span><span class="n">set_cpu</span><span class="p">(</span><span class="s2">&quot;maincpu&quot;</span><span class="p">);</span>
<span class="n">m_sbus</span><span class="o">-&gt;</span><span class="n">set_type1space</span><span class="p">(</span><span class="s2">&quot;type1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>If we want to use the convenience constructor, we just supply additional
arguments when instantiating the device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SBUS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">m_sbus</span><span class="p">,</span> <span class="mi">20</span><span class="s1">&#39;000&#39;</span><span class="mi">000</span><span class="p">,</span> <span class="n">m_maincpu</span><span class="p">,</span> <span class="n">m_type1space</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="object-finder-arrays">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Object finder arrays</a><a class="headerlink" href="#object-finder-arrays" title="Link to this heading">¶</a></h2>
<p>Many systems have multiple similar devices, I/O ports or other resources that
can be logically organised as an array.  To simplify these use cases, object
finder array types are provided.  The object finder array type names have
<code class="docutils literal notranslate"><span class="pre">_array</span></code> added to them:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>required_device</p></td>
<td><p>required_device_array</p></td>
</tr>
<tr class="row-even"><td><p>optional_device</p></td>
<td><p>optional_device_array</p></td>
</tr>
<tr class="row-odd"><td><p>required_memory_region</p></td>
<td><p>required_memory_region_array</p></td>
</tr>
<tr class="row-even"><td><p>optional_memory_region</p></td>
<td><p>optional_memory_region_array</p></td>
</tr>
<tr class="row-odd"><td><p>required_memory_bank</p></td>
<td><p>required_memory_bank_array</p></td>
</tr>
<tr class="row-even"><td><p>optional_memory_bank</p></td>
<td><p>optional_memory_bank_array</p></td>
</tr>
<tr class="row-odd"><td><p>memory_bank_creator</p></td>
<td><p>memory_bank_array_creator</p></td>
</tr>
<tr class="row-even"><td><p>required_ioport</p></td>
<td><p>required_ioport_array</p></td>
</tr>
<tr class="row-odd"><td><p>optional_ioport</p></td>
<td><p>optional_ioport_array</p></td>
</tr>
<tr class="row-even"><td><p>required_address_space</p></td>
<td><p>required_address_space_array</p></td>
</tr>
<tr class="row-odd"><td><p>optional_address_space</p></td>
<td><p>optional_address_space_array</p></td>
</tr>
<tr class="row-even"><td><p>required_region_ptr</p></td>
<td><p>required_region_ptr_array</p></td>
</tr>
<tr class="row-odd"><td><p>optional_region_ptr</p></td>
<td><p>optional_region_ptr_array</p></td>
</tr>
<tr class="row-even"><td><p>required_shared_ptr</p></td>
<td><p>required_shared_ptr_array</p></td>
</tr>
<tr class="row-odd"><td><p>optional_shared_ptr</p></td>
<td><p>optional_shared_ptr_array</p></td>
</tr>
<tr class="row-even"><td><p>memory_share_creator</p></td>
<td><p>memory_share_array_creator</p></td>
</tr>
</tbody>
</table>
<p>A common case for an object array finder is a key matrix:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">keyboard_base</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_t</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_mac_keyboard_interface</span>
<span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">keyboard_base</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">device_t</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">),</span>
<span class="w">        </span><span class="n">device_mac_keyboard_interface</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_rows</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ROW%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">bus_r</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">u8</span><span class="w"> </span><span class="nf">result</span><span class="p">(</span><span class="mh">0xffU</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span><span class="w"> </span><span class="n">m_rows</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">BIT</span><span class="p">(</span><span class="n">m_row_drive</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">m_rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">required_ioport_array</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_rows</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Constructing an object finder array is similar to constructing an object finder,
except that rather than just a tag you supply a tag format string and index
offset.  In this case, the tags of the I/O ports in the array will be <code class="docutils literal notranslate"><span class="pre">ROW0</span></code>,
<code class="docutils literal notranslate"><span class="pre">ROW1</span></code>, <code class="docutils literal notranslate"><span class="pre">ROW2</span></code>, … <code class="docutils literal notranslate"><span class="pre">ROW9</span></code>.  Note that the object finder array allocates
dynamic storage for the tags, which remain valid until destruction.</p>
<p>The object finder array is used in much the same way as a <code class="docutils literal notranslate"><span class="pre">std::array</span></code> of the
underlying object finder type.  It supports indexing, iterators, and range-based
<code class="docutils literal notranslate"><span class="pre">for</span></code> loops.</p>
<p>Because an index offset is specified, the tags don’t need to use zero-based
indices.  It’s common to use one-based indexing like this:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">dooyong_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">driver_device</span>
<span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">dooyong_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">driver_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_bg</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bg%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1U</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_fg</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fg%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1U</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">optional_device_array</span><span class="o">&lt;</span><span class="n">dooyong_rom_tilemap_device</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_bg</span><span class="p">;</span>
<span class="w">    </span><span class="n">optional_device_array</span><span class="o">&lt;</span><span class="n">dooyong_rom_tilemap_device</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_fg</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This causes <code class="docutils literal notranslate"><span class="pre">m_bg</span></code> to find devices with tags <code class="docutils literal notranslate"><span class="pre">bg1</span></code> and <code class="docutils literal notranslate"><span class="pre">bg2</span></code>, while
<code class="docutils literal notranslate"><span class="pre">m_fg</span></code> finds devices with tags <code class="docutils literal notranslate"><span class="pre">fg1</span></code> and <code class="docutils literal notranslate"><span class="pre">fg2</span></code>.  Note that the indexes
into the object finder arrays are still zero-based like any other C array.</p>
<p>It’s also possible to other format conversions, like hexadecimal (<code class="docutils literal notranslate"><span class="pre">%x</span></code> and
<code class="docutils literal notranslate"><span class="pre">%X</span></code>) or character (<code class="docutils literal notranslate"><span class="pre">%c</span></code>):</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">eurit_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">driver_device</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">eurit_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">driver_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_keys</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;KEY%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">required_ioport_array</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_keys</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In this case, the key matrix ports use tags <code class="docutils literal notranslate"><span class="pre">KEYA</span></code>, <code class="docutils literal notranslate"><span class="pre">KEYB</span></code>, <code class="docutils literal notranslate"><span class="pre">KEYC</span></code>,
<code class="docutils literal notranslate"><span class="pre">KEYD</span></code> and <code class="docutils literal notranslate"><span class="pre">KEYE</span></code>.</p>
<p>When the tags don’t follow a simple ascending sequence, you can supply a
brace-enclosed initialiser list of tags:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">seabattl_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">driver_device</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">seabattl_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">driver_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_digits</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;sc_thousand&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sc_hundred&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sc_half&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sc_unity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tm_half&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tm_unity&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">required_device_array</span><span class="o">&lt;</span><span class="n">dm9368_device</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_digits</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If the underlying object finders require additional constructor arguments,
supply them after the tag format and index offset (the same values will be used
for all elements of the array):</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">dreamwld_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">driver_device</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">dreamwld_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">driver_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_vram</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vram_%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2000U</span><span class="p">,</span><span class="w"> </span><span class="n">ENDIANNESS_BIG</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">memory_share_array_creator</span><span class="o">&lt;</span><span class="n">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_vram</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This finds or creates memory shares with tags <code class="docutils literal notranslate"><span class="pre">vram_0</span></code> and <code class="docutils literal notranslate"><span class="pre">vram_1</span></code>, each of
which is 8 KiB organised as 4,096 big-Endian 16-bit words.</p>
</section>
<section id="optional-object-finders">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Optional object finders</a><a class="headerlink" href="#optional-object-finders" title="Link to this heading">¶</a></h2>
<p>Optional object finders don’t raise an error if the target object isn’t found.
This is useful in two situations: <code class="docutils literal notranslate"><span class="pre">driver_device</span></code> implementations (state
classes) representing a family of systems where some components aren’t present
in all configurations, and devices that can optionally use a resource.  Optional
object finders provide additional member functions for testing whether the
target object was found.</p>
<section id="optional-system-components">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Optional system components</a><a class="headerlink" href="#optional-system-components" title="Link to this heading">¶</a></h3>
<p>Often a class is used to represent a family of related systems.  If a component
isn’t present in all configurations, it may be convenient to use an optional
object finder to access it.  We’ll use the Sega X-board device as an example:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">segaxbd_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">device_t</span>
<span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">segaxbd_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">device_t</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_soundcpu</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;soundcpu&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_soundcpu2</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;soundcpu2&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_segaic16vid</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;segaic16vid&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_pc_0</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_lastsurv_mux</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_adc_ports</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ADC%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_mux_ports</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MUX%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">optional_device</span><span class="o">&lt;</span><span class="n">z80_device</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_soundcpu</span><span class="p">;</span>
<span class="w">    </span><span class="n">optional_device</span><span class="o">&lt;</span><span class="n">z80_device</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_soundcpu2</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_device</span><span class="o">&lt;</span><span class="n">mb3773_device</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_watchdog</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_device</span><span class="o">&lt;</span><span class="n">segaic16_video_device</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_segaic16vid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">m_adc_reverse</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">m_pc_0</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">m_lastsurv_mux</span><span class="p">;</span>
<span class="w">    </span><span class="n">optional_ioport_array</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_adc_ports</span><span class="p">;</span>
<span class="w">    </span><span class="n">optional_ioport_array</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_mux_ports</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">optional_device</span></code> and <code class="docutils literal notranslate"><span class="pre">optional_ioport_array</span></code> members are declared and
constructed in the usual way.  Before accessing the target object, we call an
object finder’s <code class="docutils literal notranslate"><span class="pre">found()</span></code> member function to check whether it’s present in the
system (the explicit cast-to-Boolean operator can be used for the same purpose):</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">segaxbd_state::pc_0_w</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">m_pc_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>

<span class="w">    </span><span class="n">m_watchdog</span><span class="o">-&gt;</span><span class="n">write_line_ck</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">));</span>

<span class="w">    </span><span class="n">m_segaic16vid</span><span class="o">-&gt;</span><span class="n">set_display_enable</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_soundcpu</span><span class="p">.</span><span class="n">found</span><span class="p">())</span>
<span class="w">        </span><span class="n">m_soundcpu</span><span class="o">-&gt;</span><span class="n">set_input_line</span><span class="p">(</span><span class="n">INPUT_LINE_RESET</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">CLEAR_LINE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ASSERT_LINE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_soundcpu2</span><span class="p">.</span><span class="n">found</span><span class="p">())</span>
<span class="w">        </span><span class="n">m_soundcpu2</span><span class="o">-&gt;</span><span class="n">set_input_line</span><span class="p">(</span><span class="n">INPUT_LINE_RESET</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">CLEAR_LINE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ASSERT_LINE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Optional I/O ports provide a convenience member function called <code class="docutils literal notranslate"><span class="pre">read_safe</span></code>
that reads the port value if present, or returns the supplied default value
otherwise:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">u8</span><span class="w"> </span><span class="nf">segaxbd_state::analog_r</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m_pc_0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_adc_ports</span><span class="p">[</span><span class="n">which</span><span class="p">].</span><span class="n">read_safe</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_adc_reverse</span><span class="p">[</span><span class="n">which</span><span class="p">])</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span><span class="w"> </span><span class="nf">segaxbd_state::lastsurv_port_r</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_mux_ports</span><span class="p">[</span><span class="n">m_lastsurv_mux</span><span class="p">].</span><span class="n">read_safe</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The ADC ports return 0x10 (16 decimal) if they are not present, while the
multiplexed digital ports return 0xff (255 decimal) if they are not present.
Note that <code class="docutils literal notranslate"><span class="pre">read_safe</span></code> is a member of the <code class="docutils literal notranslate"><span class="pre">optional_ioport</span></code> itself, and not
a member of the target <code class="docutils literal notranslate"><span class="pre">ioport_port</span></code> object (the <code class="docutils literal notranslate"><span class="pre">optional_ioport</span></code> is not
dereferenced when using it).</p>
<p>There are some disadvantages to using optional object finders:</p>
<ul class="simple">
<li><p>There’s no way to distinguish between the target not being present, and the
target not being found due to mismatched tags, making it more error-prone.</p></li>
<li><p>Checking whether the target is present may use CPU branch prediction
resources, potentially hurting performance if it happens very frequently.</p></li>
</ul>
<p>Consider whether optional object finders are the best solution, or whether
creating a derived class for the system with additional components is more
appropriate.</p>
</section>
<section id="optional-resources">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Optional resources</a><a class="headerlink" href="#optional-resources" title="Link to this heading">¶</a></h3>
<p>Some devices can optionally use certain resources.  If the host system doesn’t
supply them, the device will still function, although some functionality may not
be available.  For example, the Virtual Boy cartridge slot responds to three
address spaces, called EXP, CHIP and ROM.  If the host system will never use one
or more of them, it doesn’t need to supply a place for the cartridge to install
the corresponding handlers.  (For example a copier may only use the ROM space.)</p>
<p>Let’s look at how this is implemented.  The Virtual Boy cartridge slot device
declares <code class="docutils literal notranslate"><span class="pre">optional_address_space</span></code> members for the three address spaces,
<code class="docutils literal notranslate"><span class="pre">offs_t</span></code> members for the base addresses in these spaces, and inline member
functions for configuring them:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">vboy_cart_slot_device</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">device_t</span><span class="p">,</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">device_image_interface</span><span class="p">,</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">device_single_card_slot_interface</span><span class="o">&lt;</span><span class="n">device_vboy_cart_interface</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">vboy_cart_slot_device</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">);</span>

<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_exp</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">no</span><span class="p">,</span><span class="w"> </span><span class="n">offs_t</span><span class="w"> </span><span class="n">base</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">m_exp_space</span><span class="p">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="w"> </span><span class="n">no</span><span class="p">);</span>
<span class="w">        </span><span class="n">m_exp_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_chip</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">no</span><span class="p">,</span><span class="w"> </span><span class="n">offs_t</span><span class="w"> </span><span class="n">base</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">m_chip_space</span><span class="p">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="w"> </span><span class="n">no</span><span class="p">);</span>
<span class="w">        </span><span class="n">m_chip_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_rom</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">no</span><span class="p">,</span><span class="w"> </span><span class="n">offs_t</span><span class="w"> </span><span class="n">base</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">m_rom_space</span><span class="p">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="w"> </span><span class="n">no</span><span class="p">);</span>
<span class="w">        </span><span class="n">m_rom_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">device_start</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">optional_address_space</span><span class="w"> </span><span class="n">m_exp_space</span><span class="p">;</span>
<span class="w">    </span><span class="n">optional_address_space</span><span class="w"> </span><span class="n">m_chip_space</span><span class="p">;</span>
<span class="w">    </span><span class="n">optional_address_space</span><span class="w"> </span><span class="n">m_rom_space</span><span class="p">;</span>
<span class="w">    </span><span class="n">offs_t</span><span class="w"> </span><span class="n">m_exp_base</span><span class="p">;</span>
<span class="w">    </span><span class="n">offs_t</span><span class="w"> </span><span class="n">m_chip_base</span><span class="p">;</span>
<span class="w">    </span><span class="n">offs_t</span><span class="w"> </span><span class="n">m_rom_base</span><span class="p">;</span>

<span class="w">    </span><span class="n">device_vboy_cart_interface</span><span class="w"> </span><span class="o">*</span><span class="n">m_cart</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">DECLARE_DEVICE_TYPE</span><span class="p">(</span><span class="n">VBOY_CART_SLOT</span><span class="p">,</span><span class="w"> </span><span class="n">vboy_cart_slot_device</span><span class="p">)</span>
</pre></div>
</div>
<p>The object finders are constructed with dummy values for the tags and space
numbers (<code class="docutils literal notranslate"><span class="pre">finder_base::DUMMY_TAG</span></code> and -1):</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vboy_cart_slot_device</span><span class="o">::</span><span class="n">vboy_cart_slot_device</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">    </span><span class="n">device_t</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">VBOY_CART_SLOT</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">),</span>
<span class="w">    </span><span class="n">device_image_interface</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">),</span>
<span class="w">    </span><span class="n">device_single_card_slot_interface</span><span class="o">&lt;</span><span class="n">device_vboy_cart_interface</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_exp_space</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_chip_space</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_rom_space</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_exp_base</span><span class="p">(</span><span class="mi">0U</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_chip_base</span><span class="p">(</span><span class="mi">0U</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_rom_base</span><span class="p">(</span><span class="mi">0U</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_cart</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To help detect configuration errors, we’ll check for cases where address spaces
have been configured but aren’t present:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">vboy_cart_slot_device::device_start</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m_exp_space</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">m_exp_space</span><span class="p">.</span><span class="n">finder_tag</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">m_exp_space</span><span class="p">.</span><span class="n">spacenum</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">emu_fatalerror</span><span class="p">(</span><span class="s">&quot;%s: Address space %d of device %s not found (EXP)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">(),</span><span class="w"> </span><span class="n">m_exp_space</span><span class="p">.</span><span class="n">spacenum</span><span class="p">(),</span><span class="w"> </span><span class="n">m_exp_space</span><span class="p">.</span><span class="n">finder_tag</span><span class="p">());</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m_chip_space</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">m_chip_space</span><span class="p">.</span><span class="n">finder_tag</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">m_chip_space</span><span class="p">.</span><span class="n">spacenum</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">emu_fatalerror</span><span class="p">(</span><span class="s">&quot;%s: Address space %d of device %s not found (CHIP)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">(),</span><span class="w"> </span><span class="n">m_chip_space</span><span class="p">.</span><span class="n">spacenum</span><span class="p">(),</span><span class="w"> </span><span class="n">m_chip_space</span><span class="p">.</span><span class="n">finder_tag</span><span class="p">());</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m_rom_space</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">m_rom_space</span><span class="p">.</span><span class="n">finder_tag</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">finder_base</span><span class="o">::</span><span class="n">DUMMY_TAG</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">m_rom_space</span><span class="p">.</span><span class="n">spacenum</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">emu_fatalerror</span><span class="p">(</span><span class="s">&quot;%s: Address space %d of device %s not found (ROM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">(),</span><span class="w"> </span><span class="n">m_rom_space</span><span class="p">.</span><span class="n">spacenum</span><span class="p">(),</span><span class="w"> </span><span class="n">m_rom_space</span><span class="p">.</span><span class="n">finder_tag</span><span class="p">());</span>

<span class="w">    </span><span class="n">m_cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_card_device</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="object-finder-types-in-more-detail">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Object finder types in more detail</a><a class="headerlink" href="#object-finder-types-in-more-detail" title="Link to this heading">¶</a></h2>
<p>All object finders provide configuration functionality:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">finder_tag</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_tag</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">device_t</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">finder_target</span><span class="p">();</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_tag</span><span class="p">(</span><span class="n">device_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_tag</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_tag</span><span class="p">(</span><span class="n">finder_base</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">finder</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">finder_tag</span></code> and <code class="docutils literal notranslate"><span class="pre">finder_target</span></code> member function provides access to the
currently configured target.  Note that the tag returned by <code class="docutils literal notranslate"><span class="pre">finder</span></code> tag is
relative to the base device.  It is not sufficient on its own to identify the
target.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">set_tag</span></code> member functions configure the target of the object finder.
These members must not be called after the object finder is resolved.  The first
form configures the base device and relative tag.  The second form sets the
relative tag and also implicitly sets the base device to the device that is
currently being configured.  This form must only be called from machine
configuration functions.  The third form sets the base object and relative tag
to the current target of another object finder.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">set_tag</span></code> member functions <strong>do not</strong> copy the relative tag.  It
is the caller’s responsibility to ensure the C string remains valid until the
object finder is resolved (or reconfigured with a different tag).  The base
device must also be valid at resolution time.  This may not be the case if the
device could be removed or replaced later.</p>
<p>All object finders provide the same interface for accessing the target object:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="nf">target</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="k">operator</span><span class="w"> </span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>These members all provide access to the target object.  The <code class="docutils literal notranslate"><span class="pre">target</span></code> member
function and cast-to-pointer operator will return <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> if the target has
not been found.  The pointer member access operator asserts that the target has
been found.</p>
<p>Optional object finders additionally provide members for testing whether the
target object has been found:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">found</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="k">explicit</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="kt">bool</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>These members return <code class="docutils literal notranslate"><span class="pre">true</span></code> if the target was found, on the assumption
that the target pointer will be non-null if the target was found.</p>
<section id="device-finders">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Device finders</a><a class="headerlink" href="#device-finders" title="Link to this heading">¶</a></h3>
<p>Device finders require one template argument for the expected device class.
This should derive from either <code class="docutils literal notranslate"><span class="pre">device_t</span></code> or <code class="docutils literal notranslate"><span class="pre">device_interface</span></code>.  The target
device object must either be an instance of this class, an instance of a class
that derives from it.  A warning message is logged if a matching device is found
but it is not an instance of the expected class.</p>
<p>Device finders provide an additional <code class="docutils literal notranslate"><span class="pre">set_tag</span></code> overload:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">set_tag</span><span class="p">(</span><span class="n">DeviceClass</span><span class="w"> </span><span class="o">&amp;</span><span class="n">object</span><span class="p">);</span>
</pre></div>
</div>
<p>This is equivalent to calling <code class="docutils literal notranslate"><span class="pre">set_tag(object,</span> <span class="pre">DEVICE_SELF)</span></code>.  Note that the
device object must not be removed or replaced before the object finder is
resolved.</p>
</section>
<section id="memory-system-object-finders">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Memory system object finders</a><a class="headerlink" href="#memory-system-object-finders" title="Link to this heading">¶</a></h3>
<p>The memory system object finders, <code class="docutils literal notranslate"><span class="pre">required_memory_region</span></code>,
<code class="docutils literal notranslate"><span class="pre">optional_memory_region</span></code>, <code class="docutils literal notranslate"><span class="pre">required_memory_bank</span></code>, <code class="docutils literal notranslate"><span class="pre">optional_memory_bank</span></code>
and <code class="docutils literal notranslate"><span class="pre">memory_bank_creator</span></code>, do not have any special functionality.  They are
often used in place of literal tags when installing memory banks in an address
space.</p>
<p>Example using memory bank finders in an address map:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">qvt70_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">driver_device</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">qvt70_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">driver_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_rombank</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rom&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_rambank</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ram%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">),</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">required_memory_bank</span><span class="w"> </span><span class="n">m_rombank</span><span class="p">;</span>
<span class="w">    </span><span class="n">required_memory_bank_array</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_rambank</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">mem_map</span><span class="p">(</span><span class="n">address_map</span><span class="w"> </span><span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">rombank_w</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">qvt70_state::mem_map</span><span class="p">(</span><span class="n">address_map</span><span class="w"> </span><span class="o">&amp;</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7fff</span><span class="p">).</span><span class="n">bankr</span><span class="p">(</span><span class="n">m_rombank</span><span class="p">);</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000</span><span class="p">).</span><span class="n">w</span><span class="p">(</span><span class="n">FUNC</span><span class="p">(</span><span class="n">qvt70_state</span><span class="o">::</span><span class="n">rombank_w</span><span class="p">));</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="mh">0xa000</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbfff</span><span class="p">).</span><span class="n">ram</span><span class="p">();</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="mh">0xc000</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdfff</span><span class="p">).</span><span class="n">bankrw</span><span class="p">(</span><span class="n">m_rambank</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="mh">0xe000</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">).</span><span class="n">bankrw</span><span class="p">(</span><span class="n">m_rambank</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example using a memory bank creator to install a memory bank dynamically:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">vegaeo_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">eolith_state</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">vegaeo_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">eolith_state</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_qs1000_bank</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qs1000_bank&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">init_vegaeo</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">memory_bank_creator</span><span class="w"> </span><span class="n">m_qs1000_bank</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">vegaeo_state::init_vegaeo</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Set up the QS1000 program ROM banking, taking care not to overlap the internal RAM</span>
<span class="w">    </span><span class="n">m_qs1000</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">().</span><span class="n">space</span><span class="p">(</span><span class="n">AS_IO</span><span class="p">).</span><span class="n">install_read_bank</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="n">m_qs1000_bank</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_qs1000_bank</span><span class="o">-&gt;</span><span class="n">configure_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">memregion</span><span class="p">(</span><span class="s">&quot;qs1000:cpu&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10000</span><span class="p">);</span>

<span class="w">    </span><span class="n">init_speedup</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="i-o-port-finders">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">I/O port finders</a><a class="headerlink" href="#i-o-port-finders" title="Link to this heading">¶</a></h3>
<p>Optional I/O port finders provide an additional convenience member function:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ioport_value</span><span class="w"> </span><span class="nf">read_safe</span><span class="p">(</span><span class="n">ioport_value</span><span class="w"> </span><span class="n">defval</span><span class="p">);</span>
</pre></div>
</div>
<p>This will read the port’s value if the target I/O port was found, or return
<code class="docutils literal notranslate"><span class="pre">defval</span></code> otherwise.  It is useful in situations where certain input devices
are not always present.</p>
</section>
<section id="address-space-finders">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Address space finders</a><a class="headerlink" href="#address-space-finders" title="Link to this heading">¶</a></h3>
<p>Address space finders accept an additional argument for the address space number
to find.  A required data width can optionally be supplied to the constructor.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">address_space_finder</span><span class="p">(</span><span class="n">device_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spacenum</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_tag</span><span class="p">(</span><span class="n">device_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spacenum</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_tag</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spacenum</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_tag</span><span class="p">(</span><span class="n">finder_base</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">finder</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spacenum</span><span class="p">);</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_tag</span><span class="p">(</span><span class="n">address_space_finder</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">finder</span><span class="p">);</span>
</pre></div>
</div>
<p>The base device and tag must identify a device that implements
<code class="docutils literal notranslate"><span class="pre">device_memory_interface</span></code>.  The address space number is a zero-based index to
one of the device’s address spaces.</p>
<p>If the width is non-zero, it must match the target address space’s data width in
bits.  If the target address space exists but has a different data width, a
warning message will be logged, and it will be treated as not being found.  If
the width is zero (the default argument value), the target address space’s data
width won’t be checked.</p>
<p>Member functions are also provided to get the configured address space number
and set the required data width:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">spacenum</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_data_width</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">width</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="memory-pointer-finders">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Memory pointer finders</a><a class="headerlink" href="#memory-pointer-finders" title="Link to this heading">¶</a></h3>
<p>The memory pointer finders, <code class="docutils literal notranslate"><span class="pre">required_region_ptr</span></code>, <code class="docutils literal notranslate"><span class="pre">optional_region_ptr</span></code>,
<code class="docutils literal notranslate"><span class="pre">required_shared_ptr</span></code>, <code class="docutils literal notranslate"><span class="pre">optional_shared_ptr</span></code> and <code class="docutils literal notranslate"><span class="pre">memory_share_creator</span></code>,
all require one template argument for the element type of the memory area.  This
should usually be an explicitly-sized unsigned integer type (<code class="docutils literal notranslate"><span class="pre">u8</span></code>, <code class="docutils literal notranslate"><span class="pre">u16</span></code>,
<code class="docutils literal notranslate"><span class="pre">u32</span></code> or <code class="docutils literal notranslate"><span class="pre">u64</span></code>).  The size of this type is compared to the width of the
memory area.  If it doesn’t match, a warning message is logged and the region or
share is treated as not being found.</p>
<p>The memory pointer finders provide an array access operator, and members for
accessing the size of the memory area:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">PointerType</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="p">[](</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="kt">size_t</span><span class="w"> </span><span class="nf">length</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="kt">size_t</span><span class="w"> </span><span class="nf">bytes</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>The array access operator returns a non-<code class="docutils literal notranslate"><span class="pre">const</span></code> reference to an element of
the memory area.  The index is in units of the element type; it must be
non-negative and less than the length of the memory area.  The <code class="docutils literal notranslate"><span class="pre">length</span></code> member
returns the number of elements in the memory area.  The <code class="docutils literal notranslate"><span class="pre">bytes</span></code> member returns
the size of the memory area in bytes.  These members should not be called if the
target region/share has not been found.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">memory_share_creator</span></code> requires additional constructor arguments for the
size and Endianness of the memory share:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">memory_share_creator</span><span class="p">(</span><span class="n">device_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">endianness_t</span><span class="w"> </span><span class="n">endianness</span><span class="p">);</span>
</pre></div>
</div>
<p>The size is specified in bytes.  If an existing memory share is found, it is an
error if its size does not match the specified size.  If the width is wider than
eight bits and an existing memory share is found, it is an error if its
Endianness does not match the specified Endianness.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">memory_share_creator</span></code> provides additional members for accessing
properties of the memory share:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">endianness_t</span><span class="w"> </span><span class="nf">endianness</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="n">u8</span><span class="w"> </span><span class="nf">bitwidth</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="n">u8</span><span class="w"> </span><span class="nf">bytewidth</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>These members return the Endianness, width in bits and width in bytes of the
memory share, respectively.  They must not be called if the memory share has not
been found.</p>
</section>
</section>
<section id="output-finders">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Output finders</a><a class="headerlink" href="#output-finders" title="Link to this heading">¶</a></h2>
<p>Output finders are used for exposing outputs that can be used by the artwork
system, or by external programs.  A common application using an external program
is a control panel or cabinet lighting controller.</p>
<p>Output finders are not really object finders, but they’re described here because
they’re used in a similar way.  There are a number of important differences to
be aware of:</p>
<ul class="simple">
<li><p>Output finders always create outputs if they do not exist.</p></li>
<li><p>Output finders must be manually resolved, they are not automatically resolved.</p></li>
<li><p>Output finders cannot have their target changed after construction.</p></li>
<li><p>Output finders are array-like, and support an arbitrary number of dimensions.</p></li>
<li><p>Output names are global, the base device has no influence.  (This will change
in the future.)</p></li>
</ul>
<p>Output finders take a variable number of template arguments corresponding to the
number of array dimensions you want.  Let’s look at an example that uses zero-,
one- and two-dimensional output finders:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">mmd2_state</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">driver_device</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">mmd2_state</span><span class="p">(</span><span class="n">machine_config</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">device_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">driver_device</span><span class="p">(</span><span class="n">mconfig</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_digits</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;digit%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_p</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;p%u_%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_led_halt</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;led_halt&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">m_led_hold</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;led_hold&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">machine_start</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">round_leds_w</span><span class="p">(</span><span class="n">offs_t</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">digit_w</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">status_callback</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">m_digit</span><span class="p">;</span>

<span class="w">    </span><span class="n">output_finder</span><span class="o">&lt;</span><span class="mi">9</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_digits</span><span class="p">;</span>
<span class="w">    </span><span class="n">output_finder</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_p</span><span class="p">;</span>
<span class="w">    </span><span class="n">output_finder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">m_led_halt</span><span class="p">;</span>
<span class="w">    </span><span class="n">output_finder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">m_led_hold</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">m_led_halt</span></code> and <code class="docutils literal notranslate"><span class="pre">m_led_hold</span></code> members are zero-dimensional output
finders.  They find a single output each.  The <code class="docutils literal notranslate"><span class="pre">m_digits</span></code> member is a
one-dimensional output finder.  It finds nine outputs organised as a
single-dimensional array.  The <code class="docutils literal notranslate"><span class="pre">m_p</span></code> member is a two-dimensional output
finder.  It finds 24 outputs organised as three rows of eight columns each.
Larger numbers of dimensions are supported.</p>
<p>The output finder constructor takes a base device reference, a format string,
and an index offset for each dimension.  In this case, all the offsets are
zero.  The one-dimensional output finder <code class="docutils literal notranslate"><span class="pre">m_digits</span></code> will find outputs
<code class="docutils literal notranslate"><span class="pre">digit0</span></code>, <code class="docutils literal notranslate"><span class="pre">digit1</span></code>, <code class="docutils literal notranslate"><span class="pre">digit2</span></code>, … <code class="docutils literal notranslate"><span class="pre">digit8</span></code>.  The two-dimensional output
finder <code class="docutils literal notranslate"><span class="pre">m_p</span></code> will find the outputs <code class="docutils literal notranslate"><span class="pre">p0_0</span></code>, <code class="docutils literal notranslate"><span class="pre">p0_1</span></code>, … <code class="docutils literal notranslate"><span class="pre">p0_7</span></code> for the
first row, <code class="docutils literal notranslate"><span class="pre">p1_0</span></code>, <code class="docutils literal notranslate"><span class="pre">p1_1</span></code>, … <code class="docutils literal notranslate"><span class="pre">p1_7</span></code> for the second row, and <code class="docutils literal notranslate"><span class="pre">p2_0</span></code>,
<code class="docutils literal notranslate"><span class="pre">p2_1</span></code>, … <code class="docutils literal notranslate"><span class="pre">p2_7</span></code> for the third row.</p>
<p>You must call <code class="docutils literal notranslate"><span class="pre">resolve</span></code> on each output finder before it can be used.  This
should be done at start time for the output values to be included in save
states:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">mmd2_state::machine_start</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">m_digits</span><span class="p">.</span><span class="n">resolve</span><span class="p">();</span>
<span class="w">    </span><span class="n">m_p</span><span class="p">.</span><span class="n">resolve</span><span class="p">();</span>
<span class="w">    </span><span class="n">m_led_halt</span><span class="p">.</span><span class="n">resolve</span><span class="p">();</span>
<span class="w">    </span><span class="n">m_led_hold</span><span class="p">.</span><span class="n">resolve</span><span class="p">();</span>

<span class="w">    </span><span class="n">save_item</span><span class="p">(</span><span class="n">NAME</span><span class="p">(</span><span class="n">m_digit</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Output finders provide operators allowing them to be assigned from or cast to
32-bit signed integers.  The assignment operator will send a notification if the
new value is different to the output’s current value.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">operator</span><span class="w"> </span><span class="n">s32</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="n">s32</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">s32</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</pre></div>
</div>
<p>To set output values, assign through the output finders, as you would with an
array of the same rank:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">mmd2_state::round_leds_w</span><span class="p">(</span><span class="n">offs_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">m_p</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="o">~</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mmd2_state::digit_w</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_digit</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span>
<span class="w">        </span><span class="n">m_digits</span><span class="p">[</span><span class="n">m_digit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mmd2_state::status_callback</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">m_led_halt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i8080_cpu_device</span><span class="o">::</span><span class="n">STATUS_HLTA</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">m_led_hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i8080_cpu_device</span><span class="o">::</span><span class="n">STATUS_WO</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="layout_script.html" class="btn btn-neutral float-left" title="MAME Layout Scripting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="inputsystem.html" class="btn btn-neutral float-right" title="Input System" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1997-2025, MAMEdev and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>