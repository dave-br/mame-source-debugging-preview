<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAME SOURCE-LEVEL DEBUGGING PREVIEW QUICK-START GUIDE</title>
      <link rel="stylesheet" type="text/css" href="html/_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="html/_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script> 
  <![endif]-->
  
  <script src="../_static/documentation_options.js?v=561e49e2"></script>
  <script src="../_static/doctools.js?v=9bcbadda"></script>
  <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/js/theme.js"></script>
<link rel="index" title="Index" href="../genindex.html" />
<link rel="search" title="Search" href="../search.html" />
<link rel="next" title="General Debugger Commands" href="general.html" />
<link rel="prev" title="Linux Lightguns" href="../advanced/linux-lightguns.html" /> 
</head>
<body>
	<div class="wy-nav-content">
        <div class="rst-content">
	<div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
		<div itemprop="articleBody">

<section id="specifying-devices-and-address-spaces">

<p><a href="index.html">Home</a></p>

<h1>MAME source-debugging preview<br>Quick-Start Guide</h1>

<h2>How to install</h2>

<p>You will need a special build of MAME and a special build of an assembler or
compiler that generates the debugging information MAME needs.  For the latter, this
preview currently includes lwtools.</p>

<p><i>This preview
currently only works with the special build of lwtools, but I may expand
the preview to CMOC and ugBasic for the CoCo if there is sufficient interest.</i></p>

<p>If you prefer to build your own, see <a href="build.html">Build Instructions</a>.</p>

<h3>MAME</h3>
<ul class="simple">
	<li><p>Go to the <a href=https://github.com/dave-br/mame-source-debugging-preview/releases>Releases</a> page, and
		click on the latest release.</p></li>
	<li><p>You will find unofficial builds there for Windows, Mac (ARM64), and Linux.  Go to your
		existing MAME installation and overwrite
		your official MAME binary with the unofficial version.  (Rename the official
		build first, so you can revert back to it if you need to!) </p> </li>
</ul>

<h3>lwtools</h3>
<ul class="simple">
	<li>From the same <a href=https://github.com/dave-br/mame-source-debugging-preview/releases>releases</a> page above, you will find unofficial builds of
		lwasm and lwlink for Windows, Mac (ARM64), and Linux.   Go to your
		existing lwtools installation and overwrite
		your official lwtools binaries with the unofficial ones.  (Rename the official
		lwasm / lwlink first, so you can revert back to them if you need to!)
		<ul class="simple">
		<li>Note: I cannot verify macos builds, but I am told this build does at least run and properly
			print usage.  Hopefully the rest works, too.</li>
		</ul>
		</li>
	</li>
</ul>

<h2>Getting started</h2>
<h3>lwtools</h3>
<p>When it's time to assemble your code, add <code class="docutils literal notranslate"><span class="pre">-i</span></code>to the lwasm command-line.  Example:</p>
<p><code class="docutils literal notranslate"><span class="pre">lwasm -9bl -omy-code.bin my-code.asm -lmy-code.lst -i</span></code></p>
<p>In addition to the usual lwasm output, the above will also generate <strong>my-code.bin.mdi</strong>, which
	contains the debugging information.  If, instead, you are assembling <i>and linking</i> use command-lines like these:</p>
<p>
<code class="docutils literal notranslate"><span class="pre">lwasm --obj -9 -l -omy-code1.obj my-code1.asm -lmy-code1.lst -i</span></code><br>
<code class="docutils literal notranslate"><span class="pre">lwasm --obj -9 -l -omy-code2.obj my-code2.asm -lmy-code2.lst -i</span></code><br>
<code class="docutils literal notranslate"><span class="pre">lwasm --obj -9 -l -omy-code3.obj my-code3.asm -lmy-code3.lst -i</span></code><br>
<code class="docutils literal notranslate"><span class="pre">lwlink -b -omy-code.bin -imy-code.mdi --map=my-code.map my-code1.obj my-code2.obj my-code3.obj</span></code></p>
<p>the first three lines will generate an MDI file for each section appearing in each assembled source file.  For example,
	if my-code1.asm contained two sections, and the other .asm files contained one, you'd get
	files named something like <strong>my-code1.obj_sectiona.mdi</strong>, <strong>my-code1.obj_sectionb.mdi</strong>,
	<strong>my-code2.obj_section.mdi</strong>, <strong>my-code3.obj_section.mdi</strong>.  lwlink looks for mdi files of these
	names and combines them together into a single MDI file, much as it combines the .obj files
	into a single .bin file.  The -i option passed to lwlink allows you to specify the name
	for the final MDI file that lwlink generates (in this case, <strong>my-code.mdi</strong>).
	</p>

<h3>MAME</h3>
<p>Once you have your MDI file, you're ready to begin debugging.  Launch MAME with the
	usual command-line options (including 
	<code class="docutils literal notranslate"><span class="pre">-debug</span></code>), and add on <code class="docutils literal notranslate"><span class="pre">
		-src_debug_info path/to/MDI/file</span></code>.  Note that you only pass a single MDI file.
		In the lwlink example above, you would specify the final MDI generated by
		lwlink (e.g., <code class="docutils literal notranslate"><span class="pre">-src_debug_info path/to/my-code.mdi</span></code>)
</p><p>		 You will then be able to bring up the source file window via
		 Options menu, Show Source command from the
		 main debugger window.  You can then use the source file window to set breakpoints and step, or
		 use the dedicated source-level debugging commands in the console window.</p>
		 <p>For fun, try executing <code class="docutils literal notranslate"><span class="pre">symlist 0</span></code>
		 from the debugger console window to view the source-level symbols available to you.
</p>
<p>There is a lot more functionality not summarized here.  For full documentation, go to
	<a href="html/debugger/index.html#source-level-debugging">Full source-level debugging docs for MAME</a> </p>

<h2>NitrOS-9</h2>
<p>There is some support for source-level debugging in an OS like NitrOS-9, which
	loads code into addresses that are known only at run-time, and not during assembling or linking.</p>
<p>You can use the <a href="html/debugger/general.html#debugger-command-sdoffset">sdoffset</a>
command to tell the debugger where the module loaded, and the argument you pass will be
applied as an offset to all addresses in the MAME debugging information file.</p>
<p>Alternatively, you can automate the process of figuring out where the module gets
	loaded and executing sdoffset by using a LUA script.  An example LUA script
	can be found
	<a href="https://github.com/dave-br/mame-source-debugging-preview/blob/main/extras/os9.lua">here</a>.
	The comments at the top explain how to use it.</p>










<h2>MMU-Aware Debugging -- This section still under construction</h2>

<p>With modern machines, typically the logical address space is far larger than the actual
	physical RAM installed on the machine. But with vintage machines, it can easily be the opposite.
	With an 8/16-bit CPU that is capable of addressing only a 64K logical address space,
	there may well be more than 64K of physical RAM installed on the machine.  The CoCo 3
	is a good example of just such a machine. There are features first introduced in
	mame-sd-0277-R2 and lwtools-sd-4.24-R2 which allow the user to help the debugger know when
	code is being swapped in and out of a range of logical addresses.  You can even automate this
	with a LUA script (see below).  The end result is an intelligent debugging experience where
	the source and symbols automatically change as physical RAM gets swapped in and out of
	the logical address space.	(Thanks to Glen	Hewlett for reporting this scenario!)</p>

<h3>Background - Multiple MDIs</h3>

<p>Typically you provide a single MAME debugging information file (MDI) on the MAME
	command line as discussed above, and
	you're good. Even in cases when you have multiple assembly files which you assemble
	to obj files, and then link together, you would still use the single MDI file generated
	by lwlink, and specify that on the MAME command line (see lwtools section above).</p>
<p>However, there are scenarios where the same “logical” addresses (i.e., the addresses
	used by the CPU to refer to an area of memory) might have different blocks of physical
	RAM mapped to them at different times.  And sometimes that physical RAM contains executable code.
	The MAME debugger needs to know which code is mapped in at a given time so it knows which
	source to show.  The debugger does not do complex analysis of the code it's debugging,
	and does not understand the different hardware nuances of the emulated machines, so it
	needs your help to know which source level debugging information to consult at any given time.</p>
<p>This is done through the use of multiple MDI files.  Rather than specifying a single MDI
	file path on the MAME command line, specify a semicolon-separated list of all the MDI
	files that comprise the program you are debugging.  So long as blocks of code that may
	overlap in the logical address space appear in different MDI files, you can tell the
	debugger which MDI files to enable or disable at any given time. And during the course
	of program execution, you can update which set of MDI files are enabled.</p>

<h3>How To</h3>

<p>In addition to generating a single combined MDI file, lwlink now also generates individual
	MDI files for each section getting linked, much as lwasm does. But lwlink knows which logical
	addresses those sections get loaded to, so, unlike lwasm, lwlink can generate these files with
	the proper addresses built in. These MDI files contain 'relocated' in their names.</p>
<p>To take advantage
	of this, ensure that any code blocks that might overlap in the logical address space at runtime
	are separated into different sections (using the usual SECTION / ENDSECTION directives already
	built into lwtools), and ensure your link script specifies these sections with the proper
	logical load addresses.</p>
<p>Run lwasm as usual, and you will still see a series of intermediate MDI files to be used
	as inputs for lwlink</p>

	TODO: PIC
<p>Run lwlink as usual, and you will now see the 'relocated' MDI files generated during the link step.</p>
<p>As mentioned above, it's fine to ignore the relocated MDI files and just specify the final
	combined MDI file to MAME if you do not need MAME to adjust source as code gets
	swapped in and out of logical address ranges.  However, if you do want to take advantange of
	"MMU-aware" debugging, specify these relocated MDI files on the MAME command-line instead of
	the single combined MDI file:</p>
	TODO: PIC
<p>From the debugger console window, use the sdlist, sdenable, sddisable commands, which work much
	like the corresponding breakpoint commands.</p>
<p>sdlist lists all of the MDI files specified on the command line, with their index, and a ‘D’ next
	to each one that is currently disabled.</p>
	TODO: PIC
<p>While debugging, as your program writes to the MMU to
	swap code in and out, use the sdenable and sddisable commands to individually enable and disable
	an MDI file by its index, so the debugger knows which blocks of code are currently active.</p>
	TODO: PIC
<p>You
	can automate this process using a LUA script. See the 
	<a href="https://github.com/dave-br/mame-source-debugging-preview/tree/main/extras/MmuSample">sample</a>
	for more information.</p>



































<h2>What if I have feedback?</h2>
<p>Bugs?  Comments?  Ideas?  Questions?  Please use the <a href="https://github.com/dave-br/mame-source-debugging-preview/discussions">
	discussion section</a> on
GitHub.  I will do my best to respond to all posts.
</p>

<h2>Other Pages</h2>
<ul class="simple">
<li><p><a href="index.html">Home</a></p></li>
<li><p>Quick Start Guide (you are here)</p></li>
<li><p><a href="limitations.html">Limitations</a> (baby steps)</p></li>
<li><p><a href="html/debugger/index.html#source-level-debugging">Full source-level debugging docs for MAME</a>
	(Full MAME docs built with additional topics on source-level debugging)</p></li>
<li><p><a href="build.html">Build Instructions</a> (optional, only if you want to build the preview yourself)</p></li>
<li><p><a href="https://github.com/dave-br/mame-source-debugging-preview/discussions">Discussions</a> (Questions, bugs, etc.)</p></li>

</ul>
</section>

</div></div></div></div>

</body>
</html>